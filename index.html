<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ä¹³å“ç ”å‘è®¡ç®—å™¨ Ultimate</title>
    
    <!-- PWA é…ç½® -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#FFFFFF">
    
    <!-- å›¾æ ‡ -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='22' fill='%230052D9'/%3E%3Cpath d='M50 20 C50 20 30 50 30 70 A20 20 0 0 0 70 70 C70 50 50 20 50 20 Z' fill='white'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='22' fill='%230052D9'/%3E%3Cpath d='M50 20 C50 20 30 50 30 70 A20 20 0 0 0 70 70 C70 50 50 20 50 20 Z' fill='white'/%3E%3C/svg%3E">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    
    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --primary: #0052D9;
            --bg: #F0F2F5;
        }
        body {
            background-color: var(--bg);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Helvetica, sans-serif;
            -webkit-tap-highlight-color: transparent;
            color: #1F2937;
            overscroll-behavior-y: none;
            user-select: none;
        }
        input { user-select: text; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

        .header-glass {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: saturate(180%) blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.08);
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
        }
        
        .pt-safe { padding-top: calc(var(--safe-top) + 16px); }
        .pb-safe { padding-bottom: calc(var(--safe-bottom) + 10px); }
        .tap-active:active { transform: scale(0.96); opacity: 0.8; transition: transform 0.1s; }
        
        .stat-capsule {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-right: 1px solid #E5E7EB;
            position: relative;
            padding: 8px 0;
        }
        .stat-capsule:last-child { border-right: none; }
        
        .list-row {
            display: flex;
            align-items: center;
            background: #fff;
            border-bottom: 1px solid #F3F4F6;
            padding: 12px 14px; 
            position: relative;
            transition: background-color 0.2s;
        }
        .list-row.locked-bg { background-color: #F9FAFB; }
        /* åæ·»åŠ åŸæ–™èƒŒæ™¯å¾®è°ƒ */
        .list-row.post-add-bg { background-color: #EFF6FF; }
        
        .stepper-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #F3F4F6;
            color: #4B5563;
            border-radius: 10px;
            font-weight: bold;
            font-size: 20px;
            transition: all 0.1s;
        }
        .stepper-btn:active:not(:disabled) { background: #E5E7EB; color: #111827; }
        .stepper-btn:disabled { opacity: 0.3; cursor: not-allowed; background: #F3F4F6; color: #9CA3AF; }
        
        .input-focus:focus-within { background: #fff; box-shadow: 0 0 0 2px var(--primary); z-index: 10; }
        
        .cost-bar { position: absolute; bottom: 0; left: 0; height: 3px; background: #10B981; opacity: 0.4; }

        /* Checkbox Style */
        .chk-round {
            width: 20px; height: 20px; border-radius: 50%; border: 2px solid #D1D5DB;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .chk-round.checked { background: #0052D9; border-color: #0052D9; }
        .chk-round.checked::after { content: ''; width: 8px; height: 5px; border-left: 2px solid white; border-bottom: 2px solid white; transform: rotate(-45deg) translate(1px, -1px); }
        
        @keyframes slide-down-sm { from { opacity:0; transform: translateY(-5px); } to { opacity:1; transform: translateY(0); } }
        .animate-slide-down { animation: slide-down-sm 0.2s ease-out; }

        /* Yogurt Mode Toggle Switch */
        .toggle-switch {
            position: relative; width: 36px; height: 20px; background: #E5E7EB; border-radius: 20px; transition: all 0.3s;
        }
        .toggle-switch.active { background: #0052D9; }
        .toggle-switch::after {
            content: ''; position: absolute; left: 2px; top: 2px; width: 16px; height: 16px; background: white; border-radius: 50%; transition: all 0.3s;
        }
        .toggle-switch.active::after { transform: translateX(16px); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/javascript">
        if ('serviceWorker' in navigator) {
            try {
                const swContent = "self.addEventListener('fetch', (e) => {}); self.addEventListener('install', (e) => { self.skipWaiting(); });";
                const blob = new Blob([swContent], {type: 'text/javascript'});
                const swUrl = URL.createObjectURL(blob);
                navigator.serviceWorker.register(swUrl).catch(e => console.log('SW skipped'));
            } catch(e) {}
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, Fragment } = React;
        const vibrate = () => { if (navigator.vibrate) navigator.vibrate(10); };

        // Icons
        const Icon = ({ d, size = 18, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={d} /></svg>
        );
        const ICONS = {
            Lock: "M7 11V7a5 5 0 0 1 10 0v4M3 11h18v11H3z", 
            Unlock: "M7 11V7a5 5 0 0 1 9.9-1M3 11h18v11H3z", 
            X: "M18 6 6 18M6 6 12 12",
            Plus: "M12 5v14M5 12h14",
            Target: "M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 16a6 6 0 1 1 6-6 6 6 0 0 1-6 6z",
            Share: "M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8M16 6l-4-4-4 4M12 2v13",
            Wand: "M15 4V2M15 16v-2M8 9h2M20 9h2M17.8 11.8 19 13M12 5l-2-2M12 13l-2 2M2 2l20 20",
            Drop: "M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z",
            Trash: "M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",
            Folder: "M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z",
            Bolt: "M13 2L3 14h9l-1 8 10-12h-9l1-8z",
            Tool: "M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z",
            Flask: "M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2M8.5 2h7M7 16h10"
        };

        const DEFAULT_INGREDIENTS = [
            { id: 'rm', name: 'ç”Ÿç‰›ä¹³', fat: 3.8, protein: 3.1, ts: 12.5, price: 4.5, sweet: 0 },
            { id: 'cr', name: 'ç¨€å¥¶æ²¹38', fat: 38.0, protein: 2.2, ts: 45.0, price: 35.0, sweet: 0 },
            { id: 'smp', name: 'è„±è„‚ç²‰', fat: 0.8, protein: 34.0, ts: 96.0, price: 28.0, sweet: 0 },
            { id: 'wmp', name: 'å…¨è„‚ç²‰', fat: 26.0, protein: 24.0, ts: 96.0, price: 32.0, sweet: 0 },
            { id: 'wpc', name: 'WPC80', fat: 6.0, protein: 80.0, ts: 95.0, price: 65.0, sweet: 0 },
            { id: 'suc', name: 'ç™½ç ‚ç³–', fat: 0.0, protein: 0.0, ts: 99.8, price: 6.5, sweet: 1.0 },
            { id: 'ery', name: 'èµ¤è—“ç³–é†‡', fat: 0.0, protein: 0.0, ts: 99.0, price: 15.0, sweet: 0.65 },
            { id: 'stab', name: 'å¤é…ç¨³å®šå‰‚', fat: 0.0, protein: 0.0, ts: 95.0, price: 45.0, sweet: 0 },
            { id: 'jam', name: 'è‰è“æœé…±', fat: 0.0, protein: 0.3, ts: 45.0, price: 12.0, sweet: 0.4, isPost: true },
            { id: 'wat', name: 'å·¥è‰ºæ°´', fat: 0.0, protein: 0.0, ts: 0.0, price: 0.005, sweet: 0 },
        ];

        // Stepper Input Component
        const StepperInput = ({ value, onChange, disabled, className }) => {
            const handleStep = (delta) => {
                if (disabled) return;
                vibrate();
                const safeVal = parseFloat(value) || 0;
                onChange({ target: { value: Math.max(0, safeVal + delta).toFixed(1) } });
            };
            return (
                <div className={`flex items-center gap-2 h-11 rounded-lg ${className} ${disabled ? '' : 'bg-blue-50/50 input-focus'}`}>
                    <button onClick={(e) => {e.stopPropagation(); handleStep(-1)}} disabled={disabled} className="stepper-btn">-</button>
                    <input 
                        type="number" 
                        value={value} 
                        disabled={disabled}
                        onChange={onChange}
                        className={`flex-1 text-center font-mono text-xl font-bold bg-transparent outline-none ${disabled ? 'text-gray-400' : 'text-blue-700'}`}
                    />
                    <button onClick={(e) => {e.stopPropagation(); handleStep(1)}} disabled={disabled} className="stepper-btn">+</button>
                </div>
            );
        };

        const App = () => {
            // State
            const [library, setLibrary] = useState(() => JSON.parse(localStorage.getItem('v7_lib')) || DEFAULT_INGREDIENTS);
            const [formula, setFormula] = useState(() => JSON.parse(localStorage.getItem('v7_formula')) || [{...DEFAULT_INGREDIENTS[0], uuid:'1', weight:850, locked:false}, {...DEFAULT_INGREDIENTS[5], uuid:'2', weight:60, locked:true}]);
            const [targets, setTargets] = useState(() => JSON.parse(localStorage.getItem('v7_targets')) || {fat:3.5, pro:3.0, ts:12.0});
            const [batchSize, setBatchSize] = useState(() => parseFloat(localStorage.getItem('v7_batch')) || 1000);
            const [isLocked, setIsLocked] = useState(() => JSON.parse(localStorage.getItem('v7_locked')) || false);
            const [savedRecipes, setSavedRecipes] = useState(() => JSON.parse(localStorage.getItem('v7_recipes')) || []);
            const [yogurtMode, setYogurtMode] = useState(() => JSON.parse(localStorage.getItem('v7_ymode')) || false);
            const [baseView, setBaseView] = useState(true); // true=Base, false=Final
            
            // UI State
            const [uiState, setUiState] = useState({ showAdd: false, showTargets: false, showGen: false, showRecipes: false, showTools: false, editId: null, mode: 'calc' });
            const [isSolving, setIsSolving] = useState(false);
            const [genSelected, setGenSelected] = useState([]);
            
            // Tools State
            const [cultureCalc, setCultureCalc] = useState({ dcuPerTon: 50, pouchSize: 50, pouchWeight: 10 }); // DCU/T, DCU/Bag, g/Bag
            const [acidity, setAcidity] = useState({ t: 70 }); 

            useEffect(() => {
                localStorage.setItem('v7_lib', JSON.stringify(library));
                localStorage.setItem('v7_formula', JSON.stringify(formula));
                localStorage.setItem('v7_targets', JSON.stringify(targets));
                localStorage.setItem('v7_batch', batchSize);
                localStorage.setItem('v7_locked', isLocked);
                localStorage.setItem('v7_recipes', JSON.stringify(savedRecipes));
                localStorage.setItem('v7_ymode', yogurtMode);
            }, [library, formula, targets, batchSize, isLocked, savedRecipes, yogurtMode]);

            // Core Calculation
            const res = useMemo(() => {
                let W=0, F=0, P=0, T=0, C=0, S=0;
                
                // è¿‡æ»¤é€»è¾‘ï¼šå¦‚æœæ˜¯é…¸å¥¶æ¨¡å¼ä¸”çœ‹åŸºæ–™ï¼Œæ’é™¤åæ·»åŠ åŸæ–™
                const activeItems = (yogurtMode && baseView) 
                    ? formula.filter(i => !i.isPost) 
                    : formula;

                activeItems.forEach(i => {
                    const w = parseFloat(i.weight)||0;
                    W+=w; 
                    F+=w*(i.fat||0); 
                    P+=w*(i.protein||0); 
                    T+=w*(i.ts||0); 
                    C+=w*(i.price||0);
                    S+=w*(i.sweet||0); // ç´¯åŠ ç”œåº¦è´¡çŒ®
                });
                const safeW = W || 1;
                return {
                    w: W,
                    fat: F/safeW,
                    pro: P/safeW,
                    ts: T/safeW,
                    pf: F>0 ? P/F : 0,
                    cost: C,
                    costPerKg: C/safeW,
                    sweetness: S/safeW // ç›¸å¯¹ç”œåº¦
                };
            }, [formula, yogurtMode, baseView]);

            const updateItem = (uuid, k, v) => setFormula(formula.map(i => i.uuid===uuid ? {...i, [k]: v} : i));
            const delItem = (uuid) => { vibrate(); setFormula(formula.filter(i => i.uuid!==uuid)); };
            const addLibItem = (item) => { vibrate(); setFormula([...formula, {...item, uuid: Date.now().toString(), weight:0, locked:false, isPost: !!item.isPost}]); setUiState({...uiState, showAdd:false}); };
            const updateLibraryItem = (id, k, v) => setLibrary(library.map(l => l.id === id ? { ...l, [k]: parseFloat(v)||0 } : l));
            
            const normalize = () => {
                vibrate();
                if(res.w === 0) return;
                // å½’ä¸€åŒ–æ—¶ï¼Œå¦‚æœæ˜¯åŸºæ–™è§†å›¾ï¼Œåªè°ƒæ•´åŸºæ–™ï¼Ÿé€šå¸¸å½’ä¸€åŒ–æ˜¯é’ˆå¯¹å…¨é…æ–¹
                // è¿™é‡Œç®€åŒ–å¤„ç†ï¼šå§‹ç»ˆå¯¹æ˜¾ç¤ºåˆ—è¡¨é‡Œçš„åŸæ–™æŒ‰æ¯”ä¾‹ç¼©æ”¾
                const ratio = batchSize / res.w;
                const newF = formula.map(i => {
                    // å¦‚æœåœ¨åŸºæ–™è§†å›¾ä¸‹ï¼Œåæ·»åŠ åŸæ–™ä¸å‚ä¸å½’ä¸€åŒ–ï¼ˆä¿æŒä¸å˜ï¼Ÿæˆ–è€…ä¹Ÿè·Ÿç€å˜ï¼Ÿï¼‰
                    // ç ”å‘ä¹ æƒ¯ï¼šé€šå¸¸å¸Œæœ›æ•´ä¸ªé…æ–¹ç¼©æ”¾ã€‚
                    // ä½†å¦‚æœåªæ˜¯è°ƒåŸºæ–™... 
                    // ç­–ç•¥ï¼šåªå½’ä¸€åŒ–å½“å‰è§†å›¾å¯è§çš„åŸæ–™ï¼Œå…¶ä»–ä¿æŒä¸å˜ï¼ˆå¦‚æœæƒ³å…¨åŠ¨å°±åˆ‡åˆ°æˆå“è§†å›¾ï¼‰
                    if (yogurtMode && baseView && i.isPost) return i; 
                    return {...i, weight: parseFloat((i.weight*ratio).toFixed(2))};
                });
                setFormula(newF);
            };

            const balanceWater = () => {
                vibrate();
                const waterIdx = formula.findIndex(i => i.name.includes('æ°´') || i.id === 'wat');
                if (waterIdx === -1) return alert("è¯·å…ˆæ·»åŠ 'å·¥è‰ºæ°´'");
                
                // è®¡ç®—å½“å‰è§†å›¾ä¸‹çš„å…¶ä»–åŸæ–™é‡
                const activeItems = (yogurtMode && baseView) ? formula.filter(i => !i.isPost) : formula;
                const otherWeight = activeItems.reduce((acc, i) => (i.uuid !== formula[waterIdx].uuid) ? acc + (parseFloat(i.weight)||0) : acc, 0);
                
                const waterNeeded = batchSize - otherWeight;
                if (waterNeeded < 0) return alert(`è¶…é‡ ${Math.abs(waterNeeded).toFixed(1)}g`);
                
                const newF = [...formula];
                // ç¡®ä¿æ°´ä¹Ÿæ˜¯å½“å‰è§†å›¾çš„ä¸€éƒ¨åˆ†
                if (yogurtMode && baseView && newF[waterIdx].isPost) {
                    return alert("å·¥è‰ºæ°´è¢«æ ‡è®°ä¸º'åæ·»åŠ 'ï¼Œæ— æ³•åœ¨åŸºæ–™æ¨¡å¼ä¸‹è¡¥æ°´");
                }
                newF[waterIdx].weight = parseFloat(waterNeeded.toFixed(2));
                setFormula(newF);
            };

            const copyReport = () => {
                vibrate();
                const modeStr = yogurtMode ? (baseView ? "[åŸºæ–™æ¨¡å¼]" : "[æˆå“æ¨¡å¼]") : "";
                const txt = `ğŸ“‹ é…æ–¹ ${modeStr}\n----------------\n` +
                    formula.map(i => `${i.name}${i.isPost?'(å)':''}: ${i.weight}g`).join('\n') +
                    `\n----------------\næ€»é‡: ${res.w.toFixed(1)}g\næŒ‡æ ‡: F${(res.fat||0).toFixed(2)}% P${(res.pro||0).toFixed(2)}% TS${(res.ts||0).toFixed(2)}% ${yogurtMode?`SE:${(res.sweetness*100).toFixed(1)}`:''}`;
                navigator.clipboard.writeText(txt).then(() => alert("å·²å¤åˆ¶"));
            };

            // Solver (Simplified for brevity)
            const autoSolve = () => {
                // ... (Keep existing logic, adjust for active items only)
                vibrate();
                // ä»…å¹³è¡¡å½“å‰è§†å›¾å¯è§ä¸”æœªé”å®šçš„
                const activeItems = (yogurtMode && baseView) ? formula.filter(i => !i.isPost) : formula;
                const unlocked = activeItems.filter(i => !i.locked);
                
                if(!unlocked.length) return alert("è¯·è§£é”åŸæ–™");
                const fixedW = activeItems.reduce((a,b)=>b.locked?a+(parseFloat(b.weight)||0):a, 0);
                const targetW = batchSize - fixedW;
                if(targetW < 0) return alert("é”å®šè¶…é‡");

                setIsSolving(true);
                setTimeout(() => {
                    // Monte Carlo logic (simplified copy)
                    let minErr = Infinity;
                    let bestWeights = unlocked.map(i => i.weight);
                    for(let k=0; k<2000; k++) {
                        let rands = unlocked.map(() => Math.random());
                        let sumR = rands.reduce((a,b)=>a+b, 0);
                        let ws = rands.map(r => (r/sumR)*targetW);
                        let cF=0, cP=0, cW=0;
                        activeItems.forEach((item) => {
                            let w = item.locked ? item.weight : 0;
                            if(!item.locked) w = ws[unlocked.findIndex(u=>u.uuid===item.uuid)];
                            cF+=w*(item.fat||0); cP+=w*(item.protein||0); cW+=w;
                        });
                        const err = Math.abs((cF/cW)-targets.fat)*3 + Math.abs((cP/cW)-targets.pro)*2;
                        if(err<minErr) { minErr=err; bestWeights=ws; }
                    }
                    
                    const newF = formula.map(i => {
                        if (yogurtMode && baseView && i.isPost) return i; // Ignore hidden
                        if (i.locked) return i;
                        const uIdx = unlocked.findIndex(u => u.uuid === i.uuid);
                        return uIdx !== -1 ? {...i, weight: parseFloat(bestWeights[uIdx].toFixed(2))} : i;
                    });
                    setFormula(newF);
                    setIsSolving(false);
                    setUiState({...uiState, showTargets:false});
                }, 500);
            };
            
            // Helper: Calc Culture Weight
            const calcCultureWeight = () => {
                // (BatchSize / 1000 / 1000) * dcuPerTon / pouchSize * pouchWeight
                // ç®€åŒ–ï¼š Batch(g) -> Ton: Batch/1e6. 
                const batchInTon = batchSize / 1000000;
                const totalDCU = batchInTon * cultureCalc.dcuPerTon;
                const grams = (totalDCU / cultureCalc.pouchSize) * cultureCalc.pouchWeight;
                return grams;
            };

            const diffColor = (v, t) => { if(!t) return 'text-gray-800'; const d=Math.abs(v-t); return d<=0.05?'text-green-600':(d<=0.2?'text-orange-500':'text-red-600'); };

            return (
                <div className="min-h-screen pb-24">
                    {/* Header */}
                    <header className="fixed top-0 left-0 right-0 z-50 header-glass pt-safe">
                        <div className="flex justify-between items-center px-4 h-12">
                            <div className="flex items-center gap-2">
                                <div className="text-sm font-extrabold text-gray-600 tracking-wider flex items-center gap-1 tap-active" onClick={() => setUiState({...uiState, showRecipes:true})}>
                                    <Icon d={ICONS.Folder} size={18} className="text-blue-600"/> DAIRY LAB
                                </div>
                                {yogurtMode && (
                                    <div className="flex bg-gray-100 rounded-lg p-0.5 ml-2">
                                        <button onClick={()=>setBaseView(true)} className={`px-2 py-0.5 text-[10px] font-bold rounded-md transition-all ${baseView?'bg-white shadow text-blue-600':'text-gray-400'}`}>åŸºæ–™</button>
                                        <button onClick={()=>setBaseView(false)} className={`px-2 py-0.5 text-[10px] font-bold rounded-md transition-all ${!baseView?'bg-white shadow text-blue-600':'text-gray-400'}`}>æˆå“</button>
                                    </div>
                                )}
                            </div>
                            <div className="flex gap-3">
                                <button onClick={() => setUiState({...uiState, showTools:true})} className="text-gray-500 tap-active"><Icon d={ICONS.Tool} size={20}/></button>
                                <button onClick={() => setUiState({...uiState, showTargets:true})} className="text-blue-600 flex items-center gap-1 text-xs font-bold bg-blue-50 px-3 py-1.5 rounded-full tap-active"><Icon d={ICONS.Target} size={14}/> ç›®æ ‡</button>
                                <button onClick={copyReport} className="text-gray-500 tap-active"><Icon d={ICONS.Share} size={20}/></button>
                            </div>
                        </div>

                        <div className="px-4 pb-3 flex items-center gap-2">
                            <div className={`flex-1 flex items-center bg-gray-100 rounded-xl px-3 h-10 transition-colors ${isLocked ? 'opacity-60' : ''}`}>
                                <span className="text-xs font-bold text-gray-500 mr-2">æŠ•æ–™</span>
                                <input type="number" value={batchSize} disabled={isLocked} onChange={e => setBatchSize(parseFloat(e.target.value))} className="bg-transparent flex-1 font-mono font-bold text-xl text-right outline-none text-gray-800"/>
                                <span className="text-xs font-bold text-gray-400 ml-1">g</span>
                            </div>
                            <button onClick={() => { vibrate(); setIsLocked(!isLocked); }} className={`w-10 h-10 flex items-center justify-center rounded-xl ${isLocked ? 'bg-amber-100 text-amber-600' : 'bg-gray-100 text-gray-400'} tap-active`}><Icon d={isLocked ? ICONS.Lock : ICONS.Unlock} size={18}/></button>
                            <button onClick={balanceWater} className="w-10 h-10 flex items-center justify-center bg-blue-100 text-blue-600 rounded-xl tap-active"><Icon d={ICONS.Drop} size={20}/></button>
                            <button onClick={normalize} className="px-4 h-10 bg-blue-600 text-white text-xs font-bold rounded-xl shadow-sm tap-active">å½’ä¸€åŒ–</button>
                        </div>

                        <div className={`grid ${yogurtMode ? 'grid-cols-5' : 'grid-cols-4'} border-t border-gray-100 h-16 bg-white`}>
                            {[
                                {l:'FAT', v:res.fat, t:targets.fat}, {l:'PRO', v:res.pro, t:targets.pro}, {l:'TS', v:res.ts, t:targets.ts}, {l:'PF', v:res.pf, t:0}
                            ].concat(yogurtMode ? [{l:'SE', v:res.sweetness*100, t:0}] : []).map((d,i) => (
                                <div key={i} className="stat-capsule">
                                    <div className="text-[10px] font-extrabold text-gray-400 scale-90 mb-0.5">{d.l}</div>
                                    <div className={`font-mono font-extrabold text-lg leading-none ${diffColor(d.v, d.t)}`}>{(d.v || 0).toFixed(2)}</div>
                                    {d.t > 0 && Math.abs(d.v - d.t) > 0.05 && <div className="text-[9px] text-gray-400 scale-90 mt-0.5 font-bold">{(d.v - d.t) > 0 ? '+' : ''}{(d.v - d.t || 0).toFixed(2)}</div>}
                                </div>
                            ))}
                        </div>
                    </header>

                    {/* List */}
                    <div className="pt-[240px] px-3"> 
                        <div className="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100 mb-4">
                            <div className="flex text-[10px] text-gray-500 font-bold bg-gray-50 py-2 px-3 uppercase tracking-wide">
                                <div className="w-24">åŸæ–™</div>
                                <div className="flex-1 text-center">æ·»åŠ é‡ (g)</div>
                                <div className="w-16 text-right">{uiState.mode === 'cost' ? 'å•ä»·' : (yogurtMode ? 'ç”œåº¦' : 'å æ¯”%')}</div>
                            </div>

                            {formula.map((item, idx) => {
                                // è§†å›¾è¿‡æ»¤ï¼šå¦‚æœåœ¨åŸºæ–™è§†å›¾ï¼Œéšè—åæ·»åŠ åŸæ–™
                                if (yogurtMode && baseView && item.isPost) return null;

                                return (
                                    <div key={item.uuid} className={`list-row tap-active ${item.locked ? 'locked-bg' : ''} ${item.isPost ? 'post-add-bg' : ''}`} onClick={() => setUiState({...uiState, editId: uiState.editId===item.uuid ? null : item.uuid})}>
                                        <div className="w-24 flex flex-col justify-center pr-1">
                                            <div className={`font-bold text-sm truncate flex items-center gap-1 ${item.locked ? 'text-gray-400' : 'text-gray-800'}`}>
                                                {item.name}
                                                {item.locked && <Icon d={ICONS.Lock} size={10} className="text-amber-500"/>}
                                                {item.isPost && <span className="text-[8px] bg-purple-100 text-purple-600 px-1 rounded">å</span>}
                                            </div>
                                            <div className="text-[9px] text-gray-400 font-mono mt-0.5 font-medium">F{item.fat} P{item.protein}</div>
                                        </div>

                                        <div className="flex-1 px-1">
                                            <StepperInput 
                                                value={item.weight} 
                                                disabled={item.locked} 
                                                onChange={(e) => !item.locked && updateItem(item.uuid, 'weight', e.target.value)} 
                                            />
                                        </div>

                                        <div className="w-16 flex flex-col items-end justify-center gap-1 relative pl-1">
                                            <div className="font-bold text-xs text-gray-700 font-mono">
                                                {uiState.mode === 'cost' ? `Â¥${item.price}` : (yogurtMode ? (item.sweet||0) : `${res.w > 0 ? (item.weight/res.w*100).toFixed(1) : 0}%`)}
                                            </div>
                                            <button onClick={(e) => { e.stopPropagation(); delItem(item.uuid); }} className="text-gray-300 hover:text-red-500 p-1"><Icon d={ICONS.X} size={14}/></button>
                                            {uiState.mode === 'cost' && <div className="cost-bar" style={{width: `${(item.weight*item.price) / (res.cost||1) * 100}%`}}></div>}
                                        </div>

                                        {/* Edit Panel */}
                                        {uiState.editId === item.uuid && (
                                            <div className="absolute left-0 right-0 top-full bg-white shadow-lg border-t border-gray-100 z-20 p-3 flex flex-col gap-3 animate-slide-up rounded-b-xl" onClick={e=>e.stopPropagation()}>
                                                <div className="flex justify-between items-center">
                                                    <div className="flex gap-2">
                                                        <button onClick={() => updateItem(item.uuid, 'locked', !item.locked)} className={`px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1 transition-colors ${item.locked ? 'bg-amber-100 text-amber-700' : 'bg-gray-100 text-gray-600'}`}>
                                                            <Icon d={item.locked ? ICONS.Unlock : ICONS.Lock} size={14}/>
                                                            {item.locked ? 'è§£é”' : 'é”å®š'}
                                                        </button>
                                                        {yogurtMode && (
                                                            <button onClick={() => updateItem(item.uuid, 'isPost', !item.isPost)} className={`px-3 py-1.5 rounded-lg text-xs font-bold flex items-center gap-1 transition-colors ${item.isPost ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-600'}`}>
                                                                {item.isPost ? 'åæ·»åŠ ' : 'åŸºæ–™'}
                                                            </button>
                                                        )}
                                                    </div>
                                                    <div className="flex items-center bg-gray-50 rounded-lg px-2 h-8"><span className="text-[10px] text-gray-400 font-bold mr-1">Â¥</span><input type="number" value={item.price} onChange={e=>updateItem(item.uuid,'price',e.target.value)} className="w-12 bg-transparent text-xs font-bold outline-none"/></div>
                                                </div>
                                                <div className="grid grid-cols-4 gap-2">
                                                    <div className="bg-gray-50 p-1.5 rounded text-center"><div className="text-[9px] text-gray-400 font-bold">FAT</div><input className="w-full bg-transparent text-center font-mono text-xs font-bold" value={item.fat} onChange={e=>updateItem(item.uuid,'fat',e.target.value)}/></div>
                                                    <div className="bg-gray-50 p-1.5 rounded text-center"><div className="text-[9px] text-gray-400 font-bold">PRO</div><input className="w-full bg-transparent text-center font-mono text-xs font-bold" value={item.protein} onChange={e=>updateItem(item.uuid,'protein',e.target.value)}/></div>
                                                    <div className="bg-gray-50 p-1.5 rounded text-center"><div className="text-[9px] text-gray-400 font-bold">TS</div><input className="w-full bg-transparent text-center font-mono text-xs font-bold" value={item.ts} onChange={e=>updateItem(item.uuid,'ts',e.target.value)}/></div>
                                                    {yogurtMode && <div className="bg-gray-50 p-1.5 rounded text-center"><div className="text-[9px] text-gray-400 font-bold">SE</div><input className="w-full bg-transparent text-center font-mono text-xs font-bold" value={item.sweet} onChange={e=>updateItem(item.uuid,'sweet',e.target.value)}/></div>}
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                );
                            })}
                        </div>

                        <div className="mt-2 text-center text-xs text-gray-400 font-mono">æ€»æˆæœ¬: <span className="font-bold text-gray-700">Â¥{(res.costPerKg || 0).toFixed(2)}/kg</span></div>
                        <button onClick={() => { vibrate(); setUiState({...uiState, showAdd:true}); }} className="mt-4 w-full py-3 rounded-xl border-2 border-dashed border-blue-200 text-blue-500 font-bold flex items-center justify-center gap-1 tap-active bg-white"><Icon d={ICONS.Plus} size={20}/> æ·»åŠ åŸæ–™</button>
                    </div>

                    {/* Bottom Switcher */}
                    <div className="fixed bottom-6 left-1/2 -translate-x-1/2 bg-white/95 backdrop-blur shadow-xl border border-gray-100 rounded-full p-1 flex gap-1 z-40">
                        <button onClick={() => setUiState({...uiState, mode:'calc'})} className={`px-5 py-2.5 rounded-full text-xs font-bold transition-all ${uiState.mode==='calc' ? 'bg-gray-900 text-white shadow-md' : 'text-gray-500'}`}>é…æ–¹</button>
                        <button onClick={() => setUiState({...uiState, mode:'cost'})} className={`px-5 py-2.5 rounded-full text-xs font-bold transition-all ${uiState.mode==='cost' ? 'bg-green-600 text-white shadow-md' : 'text-gray-500'}`}>æˆæœ¬</button>
                    </div>

                    {/* Tools Modal (Yogurt Features) */}
                    {uiState.showTools && (
                        <div className="fixed inset-0 z-50 bg-black/30 backdrop-blur-sm flex items-end" onClick={() => setUiState({...uiState, showTools:false})}>
                            <div className="bg-white w-full rounded-t-[32px] p-6 h-[70vh] flex flex-col animate-slide-up" onClick={e=>e.stopPropagation()}>
                                <div className="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
                                <h3 className="text-2xl font-extrabold text-gray-900 mb-6">ç ”å‘å·¥å…·ç®±</h3>
                                
                                {/* Toggle Yogurt Mode */}
                                <div className="flex items-center justify-between p-4 bg-gray-50 rounded-2xl mb-6">
                                    <div>
                                        <div className="font-bold text-gray-900 flex items-center gap-2"><Icon d={ICONS.Flask} size={18}/> é…¸å¥¶æ¨¡å¼</div>
                                        <div className="text-xs text-gray-400 mt-1">å¯ç”¨ç”œåº¦ã€åŸºæ–™æ‹†åˆ†å’ŒèŒç§è®¡ç®—</div>
                                    </div>
                                    <div className={`toggle-switch ${yogurtMode?'active':''}`} onClick={() => setYogurtMode(!yogurtMode)}></div>
                                </div>

                                {yogurtMode && (
                                    <div className="space-y-4 overflow-y-auto flex-1">
                                        {/* Acidity Converter */}
                                        <div className="p-4 border border-gray-100 rounded-2xl">
                                            <h4 className="font-bold text-sm text-gray-700 mb-3">é…¸åº¦æ¢ç®—</h4>
                                            <div className="flex items-center gap-4">
                                                <div className="flex-1 bg-gray-50 rounded-lg p-2">
                                                    <div className="text-[10px] text-gray-400 uppercase">å‰å°”æ¶…å°”åº¦ Â°T</div>
                                                    <input type="number" value={acidity.t} onChange={e=>setAcidity({t:parseFloat(e.target.value)})} className="w-full bg-transparent font-bold text-lg outline-none"/>
                                                </div>
                                                <div className="text-gray-300">â‰ˆ</div>
                                                <div className="flex-1 bg-blue-50 rounded-lg p-2">
                                                    <div className="text-[10px] text-blue-400 uppercase">ä¹³é…¸ %</div>
                                                    <div className="font-bold text-lg text-blue-700">{(acidity.t * 0.009).toFixed(3)}%</div>
                                                </div>
                                            </div>
                                        </div>

                                        {/* Culture Calculator */}
                                        <div className="p-4 border border-gray-100 rounded-2xl">
                                            <h4 className="font-bold text-sm text-gray-700 mb-3">èŒç§ç§°é‡è®¡ç®—</h4>
                                            <div className="grid grid-cols-3 gap-2 mb-3">
                                                <div className="bg-gray-50 p-2 rounded"><div className="text-[9px] text-gray-400">æ·»åŠ é‡ U/T</div><input type="number" value={cultureCalc.dcuPerTon} onChange={e=>setCultureCalc({...cultureCalc, dcuPerTon:parseFloat(e.target.value)})} className="w-full bg-transparent font-bold"/></div>
                                                <div className="bg-gray-50 p-2 rounded"><div className="text-[9px] text-gray-400">è§„æ ¼ U/è¢‹</div><input type="number" value={cultureCalc.pouchSize} onChange={e=>setCultureCalc({...cultureCalc, pouchSize:parseFloat(e.target.value)})} className="w-full bg-transparent font-bold"/></div>
                                                <div className="bg-gray-50 p-2 rounded"><div className="text-[9px] text-gray-400">å‡€é‡ g/è¢‹</div><input type="number" value={cultureCalc.pouchWeight} onChange={e=>setCultureCalc({...cultureCalc, pouchWeight:parseFloat(e.target.value)})} className="w-full bg-transparent font-bold"/></div>
                                            </div>
                                            <div className="flex justify-between items-center bg-purple-50 p-3 rounded-xl">
                                                <div className="text-xs text-purple-600">å½“å‰ {batchSize}g å¥¶éœ€ç§°å–:</div>
                                                <div className="font-bold text-xl text-purple-700">{calcCultureWeight().toFixed(4)} g</div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Other Modals (Target/Add/Recipes) kept same as previous */}
                    {uiState.showAdd && (
                        <div className="fixed inset-0 z-50 bg-black/30 backdrop-blur-sm flex items-end" onClick={() => setUiState({...uiState, showAdd:false})}>
                            <div className="bg-white w-full rounded-t-2xl p-4 h-[60vh] overflow-y-auto" onClick={e=>e.stopPropagation()}>
                                <div className="font-bold text-lg mb-4 text-center text-gray-800">åŸæ–™åº“</div>
                                <div className="grid grid-cols-2 gap-3">
                                    {library.map(ing => (
                                        <div key={ing.id} onClick={() => addLibItem(ing)} className="p-3 bg-gray-50 rounded-xl tap-active border border-transparent active:border-blue-200">
                                            <div className="font-bold text-gray-800">{ing.name}</div>
                                            <div className="text-[10px] text-gray-400 mt-1 font-mono">F{ing.fat} P{ing.protein} {yogurtMode?`SE${ing.sweet||0}`:''}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {uiState.showTargets && (
                        <div className="fixed inset-0 z-50 bg-black/30 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setUiState({...uiState, showTargets:false})}>
                            <div className="bg-white w-full max-w-xs rounded-2xl p-6 shadow-2xl" onClick={e=>e.stopPropagation()}>
                                <div className="font-bold text-lg mb-5 text-center text-gray-900">ç›®æ ‡è®¾å®š</div>
                                <div className="grid grid-cols-2 gap-4 mb-6">
                                    {['fat', 'pro', 'ts'].map(k => (
                                        <div key={k} className="bg-gray-50 rounded-lg p-2 border border-gray-100">
                                            <div className="text-[10px] text-gray-400 font-bold uppercase text-center">{k}%</div>
                                            <input type="number" value={targets[k]} onChange={e => setTargets({...targets, [k]:parseFloat(e.target.value)})} className="w-full bg-transparent font-bold text-xl outline-none text-center text-gray-800"/>
                                        </div>
                                    ))}
                                    <button onClick={autoSolve} disabled={isSolving} className="bg-blue-600 text-white rounded-lg font-bold text-xs flex flex-col items-center justify-center shadow-lg shadow-blue-200 tap-active p-2 h-full">
                                        <Icon d={ICONS.Wand} size={24}/>
                                        <span className="mt-1">{isSolving?'...':'å¹³è¡¡å½“å‰'}</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    {uiState.showRecipes && (
                        <div className="fixed inset-0 z-50 bg-black/30 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setUiState({...uiState, showRecipes:false})}>
                            <div className="bg-white w-full max-w-sm rounded-2xl p-5 shadow-2xl h-[60vh] flex flex-col" onClick={e=>e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-lg text-gray-900">é…æ–¹å­˜æ¡£</h3><button onClick={() => { const name = prompt("è¾“å…¥é…æ–¹åç§°"); if(name) setSavedRecipes([...savedRecipes, {id:Date.now(), name, formula, targets, batchSize, date:new Date().toLocaleDateString()}]); }} className="text-blue-600 font-bold text-sm bg-blue-50 px-3 py-1.5 rounded-lg">+ ä¿å­˜å½“å‰</button></div>
                                <div className="flex-1 overflow-y-auto space-y-2">{savedRecipes.length===0 && <div className="text-center text-gray-400 mt-10 text-sm">æš‚æ— å­˜æ¡£</div>}{savedRecipes.map(r => (<div key={r.id} className="bg-gray-50 p-3 rounded-xl flex justify-between items-center border border-gray-100" onClick={() => { if(confirm(`åŠ è½½ ${r.name}?`)) { setFormula(r.formula); setTargets(r.targets); setTargetBatchSize(r.targetBatchSize); setUiState({...uiState, showRecipes:false}); } }}><div><div className="font-bold text-gray-800">{r.name}</div><div className="text-[10px] text-gray-400">{r.date}</div></div><button onClick={(e)=>{e.stopPropagation(); setSavedRecipes(savedRecipes.filter(x=>x.id!==r.id))}} className="text-gray-300 hover:text-red-500 p-2"><Icon d={ICONS.Trash} size={16}/></button></div>))}</div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
