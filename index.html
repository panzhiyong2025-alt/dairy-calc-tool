<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>乳品配方大师 Pro</title>
    
    <!-- 1. 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 引入 React 全家桶 -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        html { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif; background-color: #F5F7FA; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .page-enter { animation: fadeScale 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeScale { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        .card-press:active { transform: scale(0.98); transition: transform 0.1s; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
        
        /* 营养成分表样式 */
        .nutrition-table { border: 2px solid #000; width: 100%; font-family: sans-serif; }
        .nutrition-table th, .nutrition-table td { border-bottom: 1px solid #000; padding: 4px 8px; }
        .nutrition-table .thick-border { border-bottom: 4px solid #000; }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden bg-[#F5F7FA]">

    <div id="root" class="h-full flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, Component } = React;

        // --- 错误边界组件 (新增) ---
        class ErrorBoundary extends Component {
            constructor(props) {
                super(props);
                this.state = { hasError: false, error: null };
            }
            static getDerivedStateFromError(error) {
                return { hasError: true, error };
            }
            componentDidCatch(error, errorInfo) {
                console.error("App Error:", error, errorInfo);
            }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="flex flex-col items-center justify-center h-screen p-6 text-center">
                            <div className="text-4xl mb-4">⚠️</div>
                            <h2 className="text-lg font-bold text-slate-800 mb-2">应用遇到了一点问题</h2>
                            <p className="text-sm text-slate-500 mb-4">请尝试刷新页面重试</p>
                            <button onClick={() => window.location.reload()} className="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm">刷新页面</button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }

        // --- 图标组件 (Lucide Icons) ---
        const Icons = {
            Milk: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size} height={p.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M8 2h8"/><path d="M9 2v2.789a4 4 0 0 1-.672 2.219C7.674 7.965 7 9.027 7 10v2.665c0 3.055 2.239 5.596 5.167 5.966A1.998 1.998 0 0 0 14 17.333V21"/><path d="M10 21h4"/><path d="M9 4h6"/></svg>,
            Yogurt: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size} height={p.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M12 21a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5C14.3 7.1 13 6.4 13 3h-2c0 3.4-1.3 4.1-3 5.5C6 10.1 5 12 5 14a7 7 0 0 0 7 7z"/><path d="M12 12v4"/><path d="M12 16h4"/></svg>,
            ChevronLeft: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size} height={p.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="m15 18-6-6 6-6"/></svg>,
            ChevronRight: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size} height={p.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="m9 18 6-6-6-6"/></svg>,
            ChevronDown: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size} height={p.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="m6 9 6 6 6-6"/></svg>,
            Plus: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size} height={p.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M5 12h14"/><path d="M12 5v14"/></svg>,
            Trash: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size} height={p.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>,
            Database: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size} height={p.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>,
            FileText: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size} height={p.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>,
            Calculator: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size} height={p.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>,
            Wrench: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size} height={p.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>,
            Layout: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size} height={p.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="3" x2="21" y1="9" y2="9"/><line x1="9" x2="9" y1="21" y2="9"/></svg>,
            Archive: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size} height={p.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><rect width="20" height="5" x="2" y="3" rx="1"/><path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"/><path d="M10 12h4"/></svg>,
            Flask: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size} height={p.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2"/><path d="M8.5 2h7"/><path d="M7 16h10"/></svg>,
            User: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size} height={p.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Table: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size} height={p.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M3 9h18"/><path d="M9 21V9"/></svg>,
            Radar: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size} height={p.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="m12 2 7 4.5v11L12 22l-7-4.5v-11L12 2z"/><path d="M12 2v20"/><path d="M12 8.5 16.5 11 12 13.5 7.5 11 12 8.5z"/></svg>,
            ShieldCheck: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size} height={p.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></svg>,
            Thermometer: (p) => <svg xmlns="http://www.w3.org/2000/svg" width={p.size} height={p.size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...p}><path d="M14 4v10.54a4 4 0 1 1-4 0V4a2 2 0 0 1 4 0Z"/><path d="M9 4v11"/></svg>
        };

        // --- 核心数据结构 ---
        const INITIAL_INGREDIENTS = [
          { id: 'rm', name: '生牛乳', protein: 3.2, fat: 3.8, ts: 12.0, cost: 4.5, carbs: 4.6, sodium: 50 },
          { id: 'skim', name: '脱脂奶', protein: 3.4, fat: 0.1, ts: 8.8, cost: 3.5, carbs: 4.8, sodium: 52 },
          { id: 'water', name: 'RO水', protein: 0, fat: 0, ts: 0, cost: 0.05, carbs: 0, sodium: 0 },
          { id: 'cream', name: '稀奶油 (38%)', protein: 2.0, fat: 38.0, ts: 42.0, cost: 35.0, carbs: 2.8, sodium: 30 },
          { id: 'butter', name: '无水奶油 (AMF)', protein: 0, fat: 99.8, ts: 99.9, cost: 60.0, carbs: 0, sodium: 0 },
          { id: 'smp', name: '脱脂乳粉 (SMP)', protein: 34.0, fat: 1.0, ts: 96.0, cost: 25.0, carbs: 54.0, sodium: 350 },
          { id: 'wpc80', name: '浓缩乳清蛋白 (WPC80)', protein: 80.0, fat: 6.0, ts: 95.0, cost: 70.0, carbs: 5.0, sodium: 180 },
          { id: 'sugar', name: '白砂糖', protein: 0, fat: 0, ts: 99.8, cost: 6.5, carbs: 99.8, sodium: 0 },
          { id: 'stab', name: '复配稳定剂', protein: 0, fat: 0, ts: 95.0, cost: 45.0, carbs: 80.0, sodium: 500 },
          { id: 'pectin', name: '果胶 (Pectin)', protein: 0, fat: 0, ts: 90.0, cost: 120.0, carbs: 10, sodium: 0, isColloid: true, maxLimit: 0.5 },
          { id: 'starter', name: '发酵菌种', protein: 0, fat: 0, ts: 10.0, cost: 200.0, carbs: 0, sodium: 0 },
        ];

        // CN NRV 标准
        const NRV = { energy: 8400, protein: 60, fat: 60, carbs: 300, sodium: 2000 };

        // --- 核心算法 ---
        const solve3x3 = (m, b) => {
          const det = (m) => 
            m[0][0] * (m[1][1] * m[2][2] - m[1][2] * m[2][1]) -
            m[0][1] * (m[1][0] * m[2][2] - m[1][2] * m[2][0]) +
            m[0][2] * (m[1][0] * m[2][1] - m[1][1] * m[2][0]);
          const D = det(m);
          if (Math.abs(D) < 1e-9) return null;
          const mx = m.map((row, i) => [b[i], row[1], row[2]]);
          const my = m.map((row, i) => [row[0], b[i], row[2]]);
          const mz = m.map((row, i) => [row[0], row[1], b[i]]);
          return [det(mx) / D, det(my) / D, det(mz) / D];
        };

        // --- 组件: 卡片容器 ---
        const SectionCard = ({ title, children, isOpen = true }) => {
          const [open, setOpen] = useState(isOpen);
          return (
            <div className="bg-white rounded-2xl p-5 shadow-[0_2px_8px_-2px_rgba(0,0,0,0.05)] border border-slate-100 transition-all duration-300">
              <div onClick={() => setOpen(!open)} className="flex items-center justify-between cursor-pointer select-none">
                <h3 className="font-bold text-slate-800 text-base flex items-center gap-2">
                    <div className="w-1 h-4 bg-blue-500 rounded-full"></div>
                    {title}
                </h3>
                {open ? <Icons.ChevronDown size={20} className="text-slate-300" /> : <Icons.ChevronRight size={20} className="text-slate-300" />}
              </div>
              {open && <div className="mt-4 pt-2 animate-in fade-in slide-in-from-top-1 duration-200">{children}</div>}
            </div>
          );
        };

        // --- 感官雷达图组件 ---
        const RadarChart = ({ data }) => {
            const size = 100;
            const center = 60;
            const radius = 40;
            const keys = Object.keys(data);
            const count = keys.length;
            const angleStep = (Math.PI * 2) / count;

            const points = keys.map((key, i) => {
                const val = data[key]; // 0-10
                const r = (val / 10) * radius;
                const angle = i * angleStep - Math.PI / 2;
                return `${center + r * Math.cos(angle)},${center + r * Math.sin(angle)}`;
            }).join(' ');

            return (
                <svg viewBox="0 0 120 120" className="w-full h-40">
                    {[0.2, 0.4, 0.6, 0.8, 1].map(scale => (
                         <polygon key={scale} points={keys.map((_, i) => {
                            const r = radius * scale;
                            const angle = i * angleStep - Math.PI / 2;
                            return `${center + r * Math.cos(angle)},${center + r * Math.sin(angle)}`;
                         }).join(' ')} fill="none" stroke="#e2e8f0" strokeWidth="1" />
                    ))}
                    <polygon points={points} fill="rgba(59, 130, 246, 0.2)" stroke="#2563eb" strokeWidth="2" />
                </svg>
            );
        }

        // --- 主应用 ---
        function App() {
          const [view, setView] = useState('home'); 
          const [moduleType, setModuleType] = useState('milk'); 
          const [ingredients, setIngredients] = useState(INITIAL_INGREDIENTS);
          
          const [targetMass, setTargetMass] = useState(1000);
          const [targetProtein, setTargetProtein] = useState(3.2);
          const [targetFat, setTargetFat] = useState(3.8);
          const [baseId, setBaseId] = useState('rm');
          const [fatId, setFatId] = useState('cream');
          const [proId, setProId] = useState('smp');
          const [additives, setAdditives] = useState([]);
          const [lossRate, setLossRate] = useState(1.5);
          const [result, setResult] = useState(null);

          const getActiveTab = () => {
             if (['home', 'input', 'result'].includes(view)) return 'design';
             if (['recipe_list'].includes(view)) return 'recipe';
             if (['tools_list', 'db', 'tool_sensory', 'tool_fvalue'].includes(view)) return 'tools';
             if (['archive'].includes(view)) return 'archive';
             return 'design';
          };
          const activeTab = getActiveTab();

          useEffect(() => {
            if (moduleType === 'yogurt') {
                setTargetProtein(3.0);
                setTargetFat(3.5);
                setProId('wpc80'); 
            } else {
                setTargetProtein(3.2);
                setTargetFat(3.8);
                setProId('smp');   
            }
          }, [moduleType]);

          useEffect(() => {
            let usedMass = 0, usedProtein = 0, usedFat = 0, usedCost = 0, usedTSMass = 0;
            let usedCarbs = 0, usedSodium = 0;
            let warnings = [];

            additives.forEach(add => {
              const ing = ingredients.find(i => i.id === add.ingredientId);
              if (ing) {
                const mass = (add.amount / 100) * targetMass;
                usedMass += mass;
                usedProtein += mass * (ing.protein / 100);
                usedFat += mass * (ing.fat / 100);
                usedTSMass += mass * (ing.ts / 100);
                usedCost += mass * ing.cost;
                usedCarbs += mass * (ing.carbs / 100);
                usedSodium += mass * (ing.sodium / 100000 * 100);

                if (ing.isColloid && ing.maxLimit && add.amount > ing.maxLimit) {
                    warnings.push(`⚠️ ${ing.name} 用量 ${add.amount}% 超过建议上限 ${ing.maxLimit}%`);
                }
              }
            });

            const remainingMass = targetMass - usedMass;
            const remTargetP = (targetMass * targetProtein / 100) - usedProtein;
            const remTargetF = (targetMass * targetFat / 100) - usedFat;

            if (remainingMass <= 0) {
              setResult({ success: false, error: "辅料添加量已超过总质量" });
              return;
            }

            const base = ingredients.find(i => i.id === baseId);
            const fatSrc = ingredients.find(i => i.id === fatId);
            const proSrc = ingredients.find(i => i.id === proId);

            if (!base || !fatSrc || !proSrc) return;

            const matrix = [
              [1, 1, 1],
              [base.protein/100, fatSrc.protein/100, proSrc.protein/100],
              [base.fat/100, fatSrc.fat/100, proSrc.fat/100]
            ];
            const vector = [remainingMass, remTargetP, remTargetF];
            const sol = solve3x3(matrix, vector);

            if (!sol || sol.some(val => val < -0.001)) {
              setResult({ success: false, error: "无解：原料组合无法满足目标，请调整蛋白/脂肪目标值。" });
              return;
            }

            const [mBase, mFat, mPro] = sol;
            const amounts = {};
            amounts[baseId] = (amounts[baseId] || 0) + mBase;
            amounts[fatId] = (amounts[fatId] || 0) + mFat;
            amounts[proId] = (amounts[proId] || 0) + mPro;
            
            [
                { mass: mBase, ing: base },
                { mass: mFat, ing: fatSrc },
                { mass: mPro, ing: proSrc }
            ].forEach(item => {
                const mass = item.mass;
                const ing = item.ing;
                usedTSMass += mass * (ing.ts / 100);
                usedCost += mass * ing.cost;
                usedCarbs += mass * (ing.carbs / 100);
                usedSodium += mass * (ing.sodium / 100000 * 100);
            });

            additives.forEach(add => { amounts[add.ingredientId] = (amounts[add.ingredientId] || 0) + ((add.amount / 100) * targetMass); });

            const finalTS = (usedTSMass / targetMass) * 100;
            const finalMSNF = finalTS - targetFat;
            
            let category = "未分类";
            if (targetProtein >= 2.9) category = "发酵乳/酸奶 (Fermented Milk)";
            else if (targetProtein >= 2.3) category = "风味发酵乳 (Flavored)";
            else if (targetProtein >= 0.7) category = "乳酸菌饮料 (Beverage)";
            else category = "非国标乳饮";

            const nutrPer100g = {
                protein: targetProtein,
                fat: targetFat,
                carbs: (usedCarbs / targetMass) * 100,
                sodium: (usedSodium / targetMass) * 100 * 1000
            };
            const energy = (17 * nutrPer100g.protein) + (17 * nutrPer100g.carbs) + (37 * nutrPer100g.fat);
            
            setResult({
              success: true, amounts, totalCost: finalCost,
              warnings, category,
              nutrition: { ...nutrPer100g, energy },
              finalStats: { protein: targetProtein, fat: targetFat, ts: finalTS, msnf: finalMSNF }
            });
          }, [targetMass, targetProtein, targetFat, baseId, fatId, proId, additives, ingredients]);

          const goInput = (type) => { setModuleType(type); setView('input'); };
          const goResult = () => {
             if (result && result.success) {
                 setView('result');
                 window.scrollTo(0,0);
             } else {
                 alert("请先修正参数错误");
             }
          };
          const updateIng = (id, k, v) => setIngredients(prev => prev.map(i => i.id === id ? { ...i, [k]: v } : i));

          const BottomNav = () => (
            <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-100 flex justify-around items-center pb-safe h-[60px] z-50 shadow-[0_-4px_12px_rgba(0,0,0,0.03)]">
                {[
                    { id: 'design', label: '设计', icon: Icons.Layout, targetView: 'home' },
                    { id: 'recipe', label: '配方', icon: Icons.Flask, targetView: 'recipe_list' },
                    { id: 'tools', label: '工具', icon: Icons.Wrench, targetView: 'tools_list' },
                    { id: 'archive', label: '存档', icon: Icons.Archive, targetView: 'archive' }
                ].map(item => {
                    const isActive = activeTab === item.id;
                    const Icon = item.icon;
                    return (
                        <button 
                            key={item.id}
                            onClick={() => setView(item.targetView)}
                            className={`flex flex-col items-center justify-center w-full h-full transition-colors ${isActive ? 'text-blue-600' : 'text-slate-400 hover:text-slate-500'}`}
                        >
                            <Icon size={22} strokeWidth={isActive ? 2.5 : 2} />
                            <span className="text-[10px] font-medium mt-1">{item.label}</span>
                        </button>
                    )
                })}
            </nav>
          );

          if (view === 'home') {
              return (
                <div className="flex flex-col h-full">
                    <div className="flex-1 overflow-y-auto px-5 pt-10 pb-24 page-enter">
                        <div className="flex items-center justify-between mb-8">
                            <div>
                                <h1 className="text-2xl font-bold text-slate-900">乳品配方大师</h1>
                                <p className="text-xs text-slate-500 mt-1">专业版 v4.0 - 智能合规</p>
                            </div>
                            <div className="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 shadow-sm">
                                <Icons.User size={20} />
                            </div>
                        </div>

                        <h2 className="text-xs font-bold text-slate-400 uppercase mb-4 tracking-wider">开始研发</h2>
                        <div className="grid grid-cols-1 gap-4">
                            <button onClick={() => goInput('milk')} className="card-press bg-white p-6 rounded-3xl border border-slate-100 shadow-sm flex items-center gap-5 relative overflow-hidden group">
                                <div className="absolute right-0 top-0 w-24 h-24 bg-blue-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
                                <div className="w-14 h-14 bg-blue-100 rounded-2xl flex items-center justify-center text-blue-600 z-10 shadow-sm">
                                    <Icons.Milk size={28} />
                                </div>
                                <div className="text-left z-10">
                                    <h3 className="text-lg font-bold text-slate-800">调制乳/乳饮</h3>
                                    <p className="text-xs text-slate-400 mt-1">巴氏奶、含乳饮料</p>
                                </div>
                            </button>

                            <button onClick={() => goInput('yogurt')} className="card-press bg-white p-6 rounded-3xl border border-slate-100 shadow-sm flex items-center gap-5 relative overflow-hidden group">
                                <div className="absolute right-0 top-0 w-24 h-24 bg-purple-50 rounded-bl-full -mr-4 -mt-4 transition-transform group-hover:scale-110"></div>
                                <div className="w-14 h-14 bg-purple-100 rounded-2xl flex items-center justify-center text-purple-600 z-10 shadow-sm">
                                    <Icons.Yogurt size={28} />
                                </div>
                                <div className="text-left z-10">
                                    <h3 className="text-lg font-bold text-slate-800">发酵乳/酸奶</h3>
                                    <p className="text-xs text-slate-400 mt-1">酸奶基料、发酵乳</p>
                                </div>
                            </button>
                        </div>
                    </div>
                    <BottomNav />
                </div>
              );
          }

          if (view === 'input') {
              const themeClass = moduleType === 'milk' ? 'bg-blue-600 shadow-blue-200' : 'bg-purple-600 shadow-purple-200';
              return (
                <div className="flex flex-col h-full">
                    <div className={`bg-white px-4 py-3 flex items-center justify-between sticky top-0 z-20 shadow-sm`}>
                        <button onClick={() => setView('home')} className="p-2 -ml-2 text-slate-500 hover:bg-slate-50 rounded-full">
                            <Icons.ChevronLeft size={24} />
                        </button>
                        <h2 className="font-bold text-lg">{moduleType === 'milk' ? '调制乳研发' : '酸奶基料研发'}</h2>
                        <div className="w-8"></div> 
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-4 page-enter pb-40 no-scrollbar">
                        <SectionCard title="设定目标指标">
                            <div className="space-y-4">
                                <div>
                                    <label className="text-xs font-bold text-slate-400 mb-1 block">投料总质量 (kg)</label>
                                    <input type="number" autoComplete="off" value={targetMass} onChange={e => setTargetMass(parseFloat(e.target.value) || 0)} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-mono text-xl font-bold text-slate-700 focus:ring-2 focus:ring-blue-500 outline-none transition-all" />
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="text-xs font-bold text-slate-400 mb-1 block">目标蛋白 (%)</label>
                                        <input type="number" autoComplete="off" step="0.1" value={targetProtein} onChange={e => setTargetProtein(parseFloat(e.target.value) || 0)} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-mono font-medium focus:ring-2 focus:ring-blue-500 outline-none transition-all" />
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-slate-400 mb-1 block">目标脂肪 (%)</label>
                                        <input type="number" autoComplete="off" step="0.1" value={targetFat} onChange={e => setTargetFat(parseFloat(e.target.value) || 0)} className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl font-mono font-medium focus:ring-2 focus:ring-blue-500 outline-none transition-all" />
                                    </div>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-slate-400 mb-1 block">预估生产损耗率 (%)</label>
                                    <input type="number" autoComplete="off" step="0.1" value={lossRate} onChange={e => setLossRate(parseFloat(e.target.value) || 0)} className="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-sm outline-none" />
                                </div>
                            </div>
                        </SectionCard>

                        <SectionCard title="平衡体系原料">
                            <div className="space-y-4">
                                <div className="p-3 bg-slate-50 rounded-xl border border-slate-100">
                                    <label className="text-xs text-slate-400 font-bold block mb-1">基料 (填充体积)</label>
                                    <select value={baseId} onChange={e => setBaseId(e.target.value)} className="w-full bg-transparent font-medium text-slate-700 outline-none appearance-none">
                                        {ingredients.map(ing => <option key={ing.id} value={ing.id}>{ing.name}</option>)}
                                    </select>
                                </div>
                                <div className="flex gap-4">
                                    <div className="flex-1 p-3 bg-slate-50 rounded-xl border border-slate-100">
                                        <label className="text-xs text-slate-400 font-bold block mb-1">脂肪调节</label>
                                        <select value={fatId} onChange={e => setFatId(e.target.value)} className="w-full bg-transparent font-medium text-slate-700 outline-none appearance-none">
                                            {ingredients.map(ing => <option key={ing.id} value={ing.id}>{ing.name}</option>)}
                                        </select>
                                    </div>
                                    <div className="flex-1 p-3 bg-slate-50 rounded-xl border border-slate-100">
                                        <label className="text-xs text-slate-400 font-bold block mb-1">蛋白调节</label>
                                        <select value={proId} onChange={e => setProId(e.target.value)} className="w-full bg-transparent font-medium text-slate-700 outline-none appearance-none">
                                            {ingredients.map(ing => <option key={ing.id} value={ing.id}>{ing.name}</option>)}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </SectionCard>

                        <SectionCard title="固定添加辅料 (含GB2760预警)" isOpen={additives.length > 0}>
                            <div className="space-y-3">
                                {additives.map(add => (
                                    <div key={add.id} className="flex items-center gap-2 animate-in slide-in-from-left-2">
                                        <select className="flex-1 p-2 bg-white border border-slate-200 rounded-lg text-sm" value={add.ingredientId} onChange={e => setAdditives(prev => prev.map(a => a.id === add.id ? {...a, ingredientId: e.target.value} : a))}>
                                            {ingredients.map(ing => <option key={ing.id} value={ing.id}>{ing.name}</option>)}
                                        </select>
                                        <div className="relative w-20">
                                            <input type="number" autoComplete="off" className="w-full p-2 bg-white border border-slate-200 rounded-lg text-sm text-right outline-none focus:border-blue-500" value={add.amount} onChange={e => setAdditives(prev => prev.map(a => a.id === add.id ? {...a, amount: parseFloat(e.target.value) || 0} : a))} />
                                            <span className="absolute right-6 top-2 text-xs text-slate-400">%</span>
                                        </div>
                                        <button onClick={() => setAdditives(prev => prev.filter(a => a.id !== add.id))} className="p-2 text-slate-300 hover:text-red-500"><Icons.Trash size={18} /></button>
                                    </div>
                                ))}
                                <button onClick={() => setAdditives([...additives, { id: Date.now().toString(), ingredientId: 'sugar', amount: 0 }])} className="w-full py-3 border border-dashed border-slate-300 rounded-xl text-slate-400 text-sm font-medium hover:bg-white hover:text-blue-500 hover:border-blue-300 transition-colors flex items-center justify-center gap-2">
                                    <Icons.Plus size={16} /> 添加原料 (支持果胶/卡拉胶检核)
                                </button>
                            </div>
                        </SectionCard>

                        <button 
                            onClick={goResult}
                            disabled={!result || !result.success}
                            className={`w-full py-4 rounded-2xl font-bold text-lg shadow-xl transition-all active:scale-95 flex items-center justify-center gap-2
                                ${result && result.success ? `${themeClass} text-white` : 'bg-slate-200 text-slate-400 cursor-not-allowed'}
                            `}
                        >
                            {result && result.success ? '生成配方与合规报告' : result?.error || '参数有误'}
                        </button>
                    </div>
                    <BottomNav />
                </div>
              );
          }

          if (view === 'result' && result) {
              const themeClass = moduleType === 'milk' ? 'bg-blue-600' : 'bg-purple-600';
              return (
                <div className="flex flex-col h-full bg-white page-enter">
                    <div className="px-4 py-3 border-b border-slate-100 flex items-center justify-between sticky top-0 bg-white z-10">
                         <button onClick={() => setView('input')} className="flex items-center gap-1 text-slate-600 font-medium">
                            <Icons.ChevronLeft size={22} /> 返回修改
                        </button>
                        <div className="flex items-center gap-2">
                            <span className="text-xs bg-emerald-100 text-emerald-700 px-2 py-1 rounded font-bold">{result.category}</span>
                        </div>
                    </div>

                    <div className="flex-1 overflow-y-auto p-4 no-scrollbar pb-24">
                        {result.warnings && result.warnings.length > 0 && (
                            <div className="mb-4 p-3 bg-amber-50 border border-amber-100 rounded-xl">
                                {result.warnings.map((w, i) => <div key={i} className="text-xs text-amber-600 font-bold flex gap-1"><span>⚠️</span>{w}</div>)}
                            </div>
                        )}

                        <div className={`${themeClass} rounded-3xl p-6 text-white shadow-xl mb-6`}>
                            <div className="flex justify-between items-start mb-2">
                                <span className="text-white/80 text-xs font-bold uppercase tracking-wider">预估总成本 (含{lossRate}%损耗)</span>
                                <div className="bg-white/20 backdrop-blur px-3 py-1 rounded-full text-xs font-medium">
                                    {targetMass} kg
                                </div>
                            </div>
                            <div className="text-4xl font-bold mb-4">
                                <span className="text-2xl align-top mr-1">¥</span>{(result.totalCost * (1 + lossRate/100)).toFixed(2)}
                            </div>
                            <div className="flex gap-3">
                                <div className="bg-black/10 rounded-lg px-3 py-2 flex-1">
                                    <div className="text-[10px] text-white/60 uppercase">单吨成本 (元)</div>
                                    <div className="font-bold text-lg">{ (result.totalCost * (1 + lossRate/100) / targetMass * 1000).toFixed(0) }</div>
                                </div>
                                <div className="bg-black/10 rounded-lg px-3 py-2 flex-1">
                                    <div className="text-[10px] text-white/60 uppercase">总干物质 (TS)</div>
                                    <div className="font-bold text-lg">{result.finalStats.ts.toFixed(1)}%</div>
                                </div>
                            </div>
                        </div>

                        <div className="mb-6">
                             <h3 className="font-bold text-slate-800 mb-3 text-lg flex items-center gap-2"><Icons.Table size={18} className="text-blue-600"/> 营养成分表 (GB 28050)</h3>
                             <div className="bg-white p-4 rounded-2xl border border-slate-100 shadow-sm">
                                <table className="nutrition-table text-sm">
                                    <thead>
                                        <tr>
                                            <th className="text-left">项目</th>
                                            <th className="text-right">每 100 g</th>
                                            <th className="text-right">NRV%</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>能量</td>
                                            <td className="text-right font-bold">{result.nutrition.energy.toFixed(0)} kJ</td>
                                            <td className="text-right">{Math.round(result.nutrition.energy / NRV.energy * 100)}%</td>
                                        </tr>
                                        <tr>
                                            <td>蛋白质</td>
                                            <td className="text-right">{result.nutrition.protein.toFixed(1)} g</td>
                                            <td className="text-right">{Math.round(result.nutrition.protein / NRV.protein * 100)}%</td>
                                        </tr>
                                        <tr>
                                            <td>脂肪</td>
                                            <td className="text-right">{result.nutrition.fat.toFixed(1)} g</td>
                                            <td className="text-right">{Math.round(result.nutrition.fat / NRV.fat * 100)}%</td>
                                        </tr>
                                        <tr>
                                            <td>碳水化合物</td>
                                            <td className="text-right">{result.nutrition.carbs.toFixed(1)} g</td>
                                            <td className="text-right">{Math.round(result.nutrition.carbs / NRV.carbs * 100)}%</td>
                                        </tr>
                                        <tr>
                                            <td>钠</td>
                                            <td className="text-right">{result.nutrition.sodium.toFixed(0)} mg</td>
                                            <td className="text-right">{Math.round(result.nutrition.sodium / NRV.sodium * 100)}%</td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div className="mt-2 text-[10px] text-slate-400">*注：数值仅基于理论计算，标签制作前请以实测为准。</div>
                             </div>
                        </div>

                        <h3 className="font-bold text-slate-800 mb-3 text-lg">生产配料单</h3>
                        <div className="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden mb-6">
                            <table className="w-full text-sm text-left">
                                <thead className="bg-slate-50 text-slate-500 font-bold text-xs">
                                    <tr>
                                        <th className="p-4 font-medium">原料名称</th>
                                        <th className="p-4 text-right font-medium">比例</th>
                                        <th className="p-4 text-right font-medium">投料量</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-50">
                                    {Object.entries(result.amounts).sort(([,a], [,b]) => b-a).map(([id, amt]) => {
                                        if(amt < 0.01) return null;
                                        const ing = ingredients.find(i => i.id === id);
                                        return (
                                            <tr key={id}>
                                                <td className="p-4 font-medium text-slate-700">{ing?.name}</td>
                                                <td className="p-4 text-right text-slate-400 font-mono">{((amt/targetMass)*100).toFixed(2)}%</td>
                                                <td className={`p-4 text-right font-bold font-mono text-base ${moduleType === 'milk' ? 'text-blue-600' : 'text-purple-600'}`}>{amt.toFixed(2)}</td>
                                            </tr>
                                        );
                                    })}
                                </tbody>
                            </table>
                        </div>
                        <button onClick={() => window.print()} className="w-full py-3 border border-slate-200 rounded-xl text-slate-600 font-medium hover:bg-slate-50">保存完整研发报告</button>
                    </div>
                    <BottomNav />
                </div>
              );
          }

          if (view === 'tools_list') {
              // 静态映射颜色类名，避免 Tailwind 动态解析失败
              const tools = [
                  { id: 'db', name: '原料数据库', desc: '管理成分与成本', icon: Icons.Database, bgClass: 'bg-emerald-100', textClass: 'text-emerald-600' },
                  { id: 'tool_sensory', name: '感官评测', desc: '生成雷达图', icon: Icons.Radar, bgClass: 'bg-pink-100', textClass: 'text-pink-600' },
                  { id: 'tool_fvalue', name: '杀菌F值计算', desc: '工艺强度评估', icon: Icons.Thermometer, bgClass: 'bg-orange-100', textClass: 'text-orange-600' },
                  { id: 'compliance', name: '合规自检', desc: 'GB2760查询', icon: Icons.ShieldCheck, bgClass: 'bg-indigo-100', textClass: 'text-indigo-600', action: () => alert("集成在配方计算结果页中") },
              ];

              return (
                  <div className="flex flex-col h-full">
                      <div className="flex-1 overflow-y-auto px-5 pt-10 pb-24 page-enter">
                          <h1 className="text-2xl font-bold text-slate-900 mb-6">研发工具箱</h1>
                          
                          <div className="grid grid-cols-2 gap-4">
                              {tools.map(t => (
                                  <div key={t.id} onClick={() => t.action ? t.action() : setView(t.id)} className="card-press bg-white p-4 rounded-2xl border border-slate-100 shadow-sm flex flex-col items-center text-center cursor-pointer">
                                      <div className={`w-12 h-12 rounded-xl ${t.bgClass} flex items-center justify-center ${t.textClass} mb-3`}>
                                          <t.icon size={24} />
                                      </div>
                                      <div className="font-bold text-slate-700">{t.name}</div>
                                      <div className="text-xs text-slate-400 mt-1">{t.desc}</div>
                                  </div>
                              ))}
                          </div>
                      </div>
                      <BottomNav />
                  </div>
              )
          }

          if (view === 'db') {
              return (
                <div className="flex flex-col h-full bg-slate-50">
                    <div className="bg-white px-4 py-3 flex items-center border-b border-slate-200 sticky top-0 z-10">
                        <button onClick={() => setView('tools_list')} className="p-2 -ml-2"><Icons.ChevronLeft size={24} /></button>
                        <h2 className="font-bold ml-2">原料成分数据库</h2>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-3 pb-24 no-scrollbar">
                        {ingredients.map(ing => (
                             <div key={ing.id} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm">
                                <div className="flex justify-between items-start mb-3">
                                    <div className="font-bold text-slate-800 text-lg">{ing.name}</div>
                                    <div className="text-xs font-mono bg-slate-100 px-2 py-1 rounded text-slate-500">TS: {ing.ts}%</div>
                                </div>
                                <div className="grid grid-cols-2 gap-3 mb-2">
                                   <div><label className="text-[10px] text-slate-400">蛋白 %</label><input type="number" autoComplete="off" className="w-full p-1 bg-slate-50 border rounded text-center" value={ing.protein} onChange={e => updateIng(ing.id, 'protein', parseFloat(e.target.value))} /></div>
                                   <div><label className="text-[10px] text-slate-400">脂肪 %</label><input type="number" autoComplete="off" className="w-full p-1 bg-slate-50 border rounded text-center" value={ing.fat} onChange={e => updateIng(ing.id, 'fat', parseFloat(e.target.value))} /></div>
                                </div>
                                <div className="grid grid-cols-2 gap-3">
                                   <div><label className="text-[10px] text-slate-400">碳水 g/100g</label><input type="number" autoComplete="off" className="w-full p-1 bg-slate-50 border rounded text-center" value={ing.carbs} onChange={e => updateIng(ing.id, 'carbs', parseFloat(e.target.value))} /></div>
                                   <div><label className="text-[10px] text-slate-400">钠 mg/100g</label><input type="number" autoComplete="off" className="w-full p-1 bg-slate-50 border rounded text-center" value={ing.sodium} onChange={e => updateIng(ing.id, 'sodium', parseFloat(e.target.value))} /></div>
                                </div>
                             </div>
                        ))}
                    </div>
                    <BottomNav />
                </div>
              );
          }

          if (view === 'tool_sensory') {
              const [scores, setScores] = useState({ color: 8, texture: 8, flavor: 8, smell: 8, appearance: 8 });
              return (
                  <div className="flex flex-col h-full bg-slate-50">
                      <div className="bg-white px-4 py-3 flex items-center border-b border-slate-200">
                          <button onClick={() => setView('tools_list')} className="p-2 -ml-2"><Icons.ChevronLeft size={24} /></button>
                          <h2 className="font-bold ml-2">感官评测 (Sensory)</h2>
                      </div>
                      <div className="p-6 space-y-6">
                          <div className="bg-white p-4 rounded-2xl shadow-sm flex justify-center">
                              <RadarChart data={scores} />
                          </div>
                          <div className="space-y-4 bg-white p-4 rounded-2xl shadow-sm">
                              {Object.keys(scores).map(k => (
                                  <div key={k}>
                                      <div className="flex justify-between text-sm font-bold capitalize mb-1">
                                          <span>{k}</span><span>{scores[k]}</span>
                                      </div>
                                      <input type="range" min="0" max="10" value={scores[k]} onChange={e => setScores({...scores, [k]: parseInt(e.target.value)})} className="w-full accent-pink-500"/>
                                  </div>
                              ))}
                          </div>
                      </div>
                      <BottomNav />
                  </div>
              )
          }

          if (view === 'tool_fvalue') {
              const [temp, setTemp] = useState(137);
              const [time, setTime] = useState(4);
              const f0 = Math.pow(10, (temp - 121.1) / 10) * (time / 60);
              return (
                  <div className="flex flex-col h-full bg-slate-50">
                      <div className="bg-white px-4 py-3 flex items-center border-b border-slate-200">
                          <button onClick={() => setView('tools_list')} className="p-2 -ml-2"><Icons.ChevronLeft size={24} /></button>
                          <h2 className="font-bold ml-2">杀菌强度计算 (F0)</h2>
                      </div>
                      <div className="p-6 space-y-6">
                          <div className="bg-orange-500 text-white p-6 rounded-2xl text-center shadow-lg">
                              <div className="text-sm opacity-80 mb-1">理论 F0 值</div>
                              <div className="text-5xl font-bold">{f0.toFixed(2)}</div>
                              <div className="text-xs mt-2 opacity-80">基准温度: 121.1°C, Z=10°C</div>
                          </div>
                          <div className="bg-white p-6 rounded-2xl shadow-sm space-y-4">
                               <div>
                                  <label className="text-sm font-bold text-slate-500">杀菌温度 (°C)</label>
                                  <input type="number" autoComplete="off" value={temp} onChange={e => setTemp(parseFloat(e.target.value))} className="w-full p-3 border rounded-xl mt-1 text-xl font-bold"/>
                               </div>
                               <div>
                                  <label className="text-sm font-bold text-slate-500">保持时间 (s)</label>
                                  <input type="number" autoComplete="off" value={time} onChange={e => setTime(parseFloat(e.target.value))} className="w-full p-3 border rounded-xl mt-1 text-xl font-bold"/>
                               </div>
                          </div>
                      </div>
                      <BottomNav />
                  </div>
              )
          }
          
          if (view === 'archive' || view === 'recipe_list') {
             return (
                <div className="flex flex-col h-full justify-center items-center text-slate-400">
                    <Icons.Archive size={48} className="mb-4 opacity-20" />
                    <p>存档与历史记录模块</p>
                    <button onClick={() => setView('home')} className="mt-4 text-blue-600 font-bold">返回首页</button>
                    <BottomNav />
                </div>
             )
          }

          return null;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        // Wrap in ErrorBoundary
        root.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>
        );
    </script>
</body>
</html>
