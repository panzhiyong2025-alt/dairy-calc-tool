import React, { useState, useEffect, useMemo } from 'react';
import { Calculator, Beaker, Droplets, Save, RefreshCw, Plus, Trash2, AlertCircle, ChevronRight, Database } from 'lucide-react';

// --- 类型定义 ---
type Ingredient = {
  id: string;
  name: string;
  protein: number; // %
  fat: number;     // %
  ts: number;      // Total Solids %
  cost: number;    // RMB/kg
  isDefault?: boolean;
};

type Additive = {
  id: string;
  ingredientId: string;
  amount: number; // % of total batch
};

type SolverResult = {
  success: boolean;
  amounts: { [key: string]: number }; // kg
  totalCost: number;
  finalStats: {
    protein: number;
    fat: number;
    ts: number;
    msnf: number;
  };
  error?: string;
};

// --- 初始数据 ---
const INITIAL_INGREDIENTS: Ingredient[] = [
  { id: 'rm', name: '生牛乳 (Raw Milk)', protein: 3.2, fat: 3.8, ts: 12.0, cost: 4.5, isDefault: true },
  { id: 'skim', name: '脱脂奶 (Skim Milk)', protein: 3.4, fat: 0.1, ts: 8.8, cost: 3.5, isDefault: true },
  { id: 'water', name: 'RO水 (Water)', protein: 0, fat: 0, ts: 0, cost: 0.05, isDefault: true },
  { id: 'cream', name: '稀奶油 (Cream 38%)', protein: 2.0, fat: 38.0, ts: 42.0, cost: 35.0, isDefault: true },
  { id: 'butter', name: '无水奶油 (AMF)', protein: 0, fat: 99.8, ts: 99.9, cost: 60.0, isDefault: true },
  { id: 'smp', name: '脱脂乳粉 (SMP)', protein: 34.0, fat: 1.0, ts: 96.0, cost: 25.0, isDefault: true },
  { id: 'wpc80', name: '浓缩乳清蛋白 (WPC80)', protein: 80.0, fat: 6.0, ts: 95.0, cost: 70.0, isDefault: true },
  { id: 'sugar', name: '白砂糖 (Sugar)', protein: 0, fat: 0, ts: 99.8, cost: 6.5, isDefault: true },
  { id: 'stab', name: '稳定剂 (Stabilizer)', protein: 0, fat: 0, ts: 95.0, cost: 45.0, isDefault: true },
];

// --- 核心算法：三元方程求解器 ---
// 使用克莱姆法则 (Cramer's Rule) 求解 Ax = B
const solve3x3 = (
  m: number[][], // Matrix 3x3 [Row][Col]
  b: number[]    // Result Vector
): number[] | null => {
  const det = (m: number[][]) => 
    m[0][0] * (m[1][1] * m[2][2] - m[1][2] * m[2][1]) -
    m[0][1] * (m[1][0] * m[2][2] - m[1][2] * m[2][0]) +
    m[0][2] * (m[1][0] * m[2][1] - m[1][1] * m[2][0]);

  const D = det(m);
  if (Math.abs(D) < 1e-9) return null; // 无解或无穷解

  // Replace columns for Dx, Dy, Dz
  const mx = m.map((row, i) => [b[i], row[1], row[2]]);
  const my = m.map((row, i) => [row[0], b[i], row[2]]);
  const mz = m.map((row, i) => [row[0], row[1], b[i]]);

  return [det(mx) / D, det(my) / D, det(mz) / D];
};

export default function DairyStandardizer() {
  // --- State ---
  const [ingredients, setIngredients] = useState<Ingredient[]>(INITIAL_INGREDIENTS);
  
  // 目标参数
  const [targetMass, setTargetMass] = useState(1000); // kg
  const [targetProtein, setTargetProtein] = useState(3.5); // %
  const [targetFat, setTargetFat] = useState(3.8); // %

  // 求解器选择
  const [baseId, setBaseId] = useState('rm');   // 基料 (通常是奶或水)
  const [fatId, setFatId] = useState('cream');  // 脂肪调节剂
  const [proId, setProId] = useState('smp');    // 蛋白调节剂

  // 固定添加物 (Pre-mix)
  const [additives, setAdditives] = useState<Additive[]>([]);
  
  // 结果
  const [result, setResult] = useState<SolverResult | null>(null);
  const [activeTab, setActiveTab] = useState<'solver' | 'database'>('solver');

  // --- Logic ---
  const handleSolve = () => {
    // 1. 计算固定添加物的占用量
    let usedMass = 0;
    let usedProtein = 0;
    let usedFat = 0;
    let usedCost = 0;
    let usedTSMass = 0;

    additives.forEach(add => {
      const ing = ingredients.find(i => i.id === add.ingredientId);
      if (ing) {
        const mass = (add.amount / 100) * targetMass;
        usedMass += mass;
        usedProtein += mass * (ing.protein / 100);
        usedFat += mass * (ing.fat / 100);
        usedTSMass += mass * (ing.ts / 100);
        usedCost += mass * ing.cost;
      }
    });

    // 2. 计算剩余需要平衡的目标
    const remainingMass = targetMass - usedMass;
    const remainingTargetProteinMass = (targetMass * targetProtein / 100) - usedProtein;
    const remainingTargetFatMass = (targetMass * targetFat / 100) - usedFat;

    if (remainingMass <= 0) {
      setResult({ success: false, amounts: {}, totalCost: 0, finalStats: { protein: 0, fat: 0, ts: 0, msnf: 0 }, error: "固定添加物已超过总质量" });
      return;
    }

    // 3. 获取三种平衡原料的数据
    const base = ingredients.find(i => i.id === baseId)!;
    const fatSrc = ingredients.find(i => i.id === fatId)!;
    const proSrc = ingredients.find(i => i.id === proId)!;

    // 4. 构建方程组
    // x + y + z = remainingMass
    // x*P1 + y*P2 + z*P3 = remainingTargetProteinMass
    // x*F1 + y*F2 + z*F3 = remainingTargetFatMass

    const matrix = [
      [1, 1, 1],
      [base.protein/100, fatSrc.protein/100, proSrc.protein/100],
      [base.fat/100, fatSrc.fat/100, proSrc.fat/100]
    ];
    const vector = [remainingMass, remainingTargetProteinMass, remainingTargetFatMass];

    const solution = solve3x3(matrix, vector);

    if (!solution || solution.some(val => val < -0.001)) {
      // 允许极小的负数作为计算误差，但大的负数意味着不可行
      setResult({ 
        success: false, 
        amounts: {}, 
        totalCost: 0, 
        finalStats: { protein: 0, fat: 0, ts: 0, msnf: 0 },
        error: "无法通过当前原料组合达到目标。可能原因：\n1. 目标值过高，原料无法满足。\n2. 目标值过低，基料本身已超标。\n3. 尝试更换调节剂（例如用无水奶油代替稀奶油）。"
      });
      return;
    }

    // 5. 汇总结果
    const [mBase, mFat, mPro] = solution;
    const amounts: {[key:string]: number} = {};
    
    // 添加平衡剂
    amounts[baseId] = (amounts[baseId] || 0) + mBase;
    amounts[fatId] = (amounts[fatId] || 0) + mFat;
    amounts[proId] = (amounts[proId] || 0) + mPro;

    // 添加固定物
    additives.forEach(add => {
      amounts[add.ingredientId] = (amounts[add.ingredientId] || 0) + ((add.amount / 100) * targetMass);
    });

    // 计算最终统计
    let finalCost = usedCost + (mBase * base.cost) + (mFat * fatSrc.cost) + (mPro * proSrc.cost);
    let finalTSMass = usedTSMass + (mBase * base.ts/100) + (mFat * fatSrc.ts/100) + (mPro * proSrc.ts/100);
    
    setResult({
      success: true,
      amounts,
      totalCost: finalCost,
      finalStats: {
        protein: targetProtein,
        fat: targetFat,
        ts: (finalTSMass / targetMass) * 100,
        msnf: ((finalTSMass / targetMass) * 100) - targetFat
      }
    });
  };

  // --- Handlers ---
  const updateIngredient = (id: string, field: keyof Ingredient, value: number) => {
    setIngredients(prev => prev.map(i => i.id === id ? { ...i, [field]: value } : i));
  };

  const addAdditive = () => {
    setAdditives([...additives, { id: Date.now().toString(), ingredientId: 'sugar', amount: 0 }]);
  };

  const updateAdditive = (id: string, field: keyof Additive, value: any) => {
    setAdditives(prev => prev.map(a => a.id === id ? { ...a, [field]: value } : a));
  };

  const removeAdditive = (id: string) => {
    setAdditives(prev => prev.filter(a => a.id !== id));
  };

  // 每次输入变化自动计算
  useEffect(() => {
    handleSolve();
  }, [targetMass, targetProtein, targetFat, baseId, fatId, proId, additives, ingredients]);


  // --- Components ---
  
  const IngredientSelect = ({ label, value, onChange, filterType }: { label: string, value: string, onChange: (val: string) => void, filterType?: string }) => (
    <div className="mb-4">
      <label className="block text-xs font-bold text-slate-500 uppercase mb-1">{label}</label>
      <div className="relative">
        <select 
          value={value} 
          onChange={(e) => onChange(e.target.value)}
          className="w-full bg-white border border-slate-300 text-slate-700 py-2 px-3 rounded shadow-sm focus:outline-none focus:border-blue-500 appearance-none"
        >
          {ingredients.map(ing => (
            <option key={ing.id} value={ing.id}>
              {ing.name} (P:{ing.protein}% F:{ing.fat}%)
            </option>
          ))}
        </select>
        <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500">
          <ChevronRight size={16} className="rotate-90" />
        </div>
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800">
      {/* Header */}
      <header className="bg-blue-700 text-white p-4 shadow-lg">
        <div className="max-w-6xl mx-auto flex justify-between items-center">
          <div className="flex items-center gap-2">
            <Beaker className="h-6 w-6" />
            <h1 className="text-xl font-bold tracking-tight">DairyStandardizer <span className="opacity-70 text-sm font-normal ml-2">乳品配方计算机 Pro</span></h1>
          </div>
          <div className="flex gap-2">
            <button 
              onClick={() => setActiveTab('solver')}
              className={`px-4 py-1.5 rounded-full text-sm font-medium transition ${activeTab === 'solver' ? 'bg-white text-blue-700' : 'bg-blue-800 text-blue-200 hover:bg-blue-600'}`}
            >
              <Calculator size={14} className="inline mr-1" /> 配方设计
            </button>
            <button 
              onClick={() => setActiveTab('database')}
              className={`px-4 py-1.5 rounded-full text-sm font-medium transition ${activeTab === 'database' ? 'bg-white text-blue-700' : 'bg-blue-800 text-blue-200 hover:bg-blue-600'}`}
            >
              <Database size={14} className="inline mr-1" /> 原料库
            </button>
          </div>
        </div>
      </header>

      <main className="max-w-6xl mx-auto p-4 md:p-6">
        
        {activeTab === 'database' && (
          <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
            <div className="p-6 border-b border-slate-100 flex justify-between items-center">
              <h2 className="text-lg font-bold text-slate-700">原料成分数据库</h2>
              <span className="text-xs text-slate-500 bg-slate-100 px-2 py-1 rounded">双击数值可修改</span>
            </div>
            <div className="overflow-x-auto">
              <table className="w-full text-left text-sm">
                <thead className="bg-slate-50 text-slate-500 uppercase font-bold">
                  <tr>
                    <th className="p-4">原料名称</th>
                    <th className="p-4">蛋白 (%)</th>
                    <th className="p-4">脂肪 (%)</th>
                    <th className="p-4">总干物质 (%)</th>
                    <th className="p-4">成本 (元/kg)</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-slate-100">
                  {ingredients.map(ing => (
                    <tr key={ing.id} className="hover:bg-blue-50 transition">
                      <td className="p-4 font-medium text-slate-700">{ing.name}</td>
                      <td className="p-4">
                        <input 
                          type="number" 
                          value={ing.protein} 
                          onChange={(e) => updateIngredient(ing.id, 'protein', parseFloat(e.target.value))}
                          className="w-20 bg-transparent border-b border-transparent hover:border-blue-300 focus:border-blue-500 focus:outline-none"
                        />
                      </td>
                      <td className="p-4">
                        <input 
                          type="number" 
                          value={ing.fat} 
                          onChange={(e) => updateIngredient(ing.id, 'fat', parseFloat(e.target.value))}
                          className="w-20 bg-transparent border-b border-transparent hover:border-blue-300 focus:border-blue-500 focus:outline-none"
                        />
                      </td>
                      <td className="p-4">
                        <input 
                          type="number" 
                          value={ing.ts} 
                          onChange={(e) => updateIngredient(ing.id, 'ts', parseFloat(e.target.value))}
                          className="w-20 bg-transparent border-b border-transparent hover:border-blue-300 focus:border-blue-500 focus:outline-none"
                        />
                      </td>
                      <td className="p-4">
                        <input 
                          type="number" 
                          value={ing.cost} 
                          onChange={(e) => updateIngredient(ing.id, 'cost', parseFloat(e.target.value))}
                          className="w-20 bg-transparent border-b border-transparent hover:border-blue-300 focus:border-blue-500 focus:outline-none"
                        />
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        )}

        {activeTab === 'solver' && (
          <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            {/* Left Column: Inputs */}
            <div className="lg:col-span-1 space-y-6">
              
              {/* 1. Target Settings */}
              <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                <div className="flex items-center gap-2 mb-4 text-blue-700">
                  <div className="p-1.5 bg-blue-100 rounded-md">
                    <Droplets size={18} />
                  </div>
                  <h2 className="font-bold">1. 设定目标</h2>
                </div>
                
                <div className="space-y-4">
                  <div>
                    <label className="block text-xs font-bold text-slate-500 uppercase mb-1">投料总量 (Total Mass)</label>
                    <div className="flex items-center">
                      <input 
                        type="number" 
                        value={targetMass} 
                        onChange={(e) => setTargetMass(parseFloat(e.target.value))}
                        className="flex-1 border border-slate-300 rounded-l px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                      />
                      <span className="bg-slate-100 border border-l-0 border-slate-300 px-3 py-2 rounded-r text-slate-600 text-sm">kg</span>
                    </div>
                  </div>
                  
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-xs font-bold text-slate-500 uppercase mb-1">目标蛋白</label>
                      <div className="flex items-center">
                        <input 
                          type="number" 
                          step="0.1"
                          value={targetProtein} 
                          onChange={(e) => setTargetProtein(parseFloat(e.target.value))}
                          className="w-full border border-slate-300 rounded-l px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                        />
                        <span className="bg-slate-100 border border-l-0 border-slate-300 px-2 py-2 rounded-r text-slate-600 text-sm">%</span>
                      </div>
                    </div>
                    <div>
                      <label className="block text-xs font-bold text-slate-500 uppercase mb-1">目标脂肪</label>
                      <div className="flex items-center">
                        <input 
                          type="number" 
                          step="0.1"
                          value={targetFat} 
                          onChange={(e) => setTargetFat(parseFloat(e.target.value))}
                          className="w-full border border-slate-300 rounded-l px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:outline-none"
                        />
                        <span className="bg-slate-100 border border-l-0 border-slate-300 px-2 py-2 rounded-r text-slate-600 text-sm">%</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* 2. Additives */}
              <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                <div className="flex justify-between items-center mb-4">
                  <div className="flex items-center gap-2 text-purple-700">
                    <div className="p-1.5 bg-purple-100 rounded-md">
                      <Plus size={18} />
                    </div>
                    <h2 className="font-bold">2. 固定添加 (辅料)</h2>
                  </div>
                  <button onClick={addAdditive} className="text-xs bg-purple-50 text-purple-700 px-2 py-1 rounded hover:bg-purple-100">+ 添加</button>
                </div>
                
                <div className="space-y-3">
                  {additives.length === 0 && <p className="text-sm text-slate-400 italic">无固定添加物 (如糖、稳定剂)</p>}
                  {additives.map(add => (
                    <div key={add.id} className="flex items-center gap-2 bg-slate-50 p-2 rounded border border-slate-100">
                      <select 
                        value={add.ingredientId}
                        onChange={(e) => updateAdditive(add.id, 'ingredientId', e.target.value)}
                        className="flex-1 text-sm bg-transparent focus:outline-none"
                      >
                        {ingredients.map(ing => <option key={ing.id} value={ing.id}>{ing.name}</option>)}
                      </select>
                      <input 
                        type="number" 
                        placeholder="%"
                        value={add.amount}
                        onChange={(e) => updateAdditive(add.id, 'amount', parseFloat(e.target.value))}
                        className="w-16 text-sm bg-white border border-slate-200 rounded px-1 py-1 text-right"
                      />
                      <span className="text-xs text-slate-500">%</span>
                      <button onClick={() => removeAdditive(add.id)} className="text-slate-400 hover:text-red-500"><Trash2 size={14} /></button>
                    </div>
                  ))}
                </div>
              </div>

              {/* 3. Standardization Base */}
              <div className="bg-white p-5 rounded-xl shadow-sm border border-slate-200">
                <div className="flex items-center gap-2 mb-4 text-indigo-700">
                  <div className="p-1.5 bg-indigo-100 rounded-md">
                    <RefreshCw size={18} />
                  </div>
                  <h2 className="font-bold">3. 平衡体系 (Solver)</h2>
                </div>
                <p className="text-xs text-slate-500 mb-4">选择三种原料，系统将自动调整它们的比例以精准命中目标蛋白和脂肪。</p>
                
                <IngredientSelect label="基料 (Base - 体积填充)" value={baseId} onChange={setBaseId} />
                <IngredientSelect label="脂肪来源 (Fat Source)" value={fatId} onChange={setFatId} />
                <IngredientSelect label="蛋白来源 (Protein Source)" value={proId} onChange={setProId} />
              </div>

            </div>

            {/* Right Column: Results */}
            <div className="lg:col-span-2">
              <div className="bg-white h-full rounded-xl shadow-md border border-slate-200 flex flex-col">
                <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50 rounded-t-xl">
                  <h2 className="text-lg font-bold text-slate-800">配方计算结果</h2>
                  {result?.success && (
                    <span className="text-green-600 text-sm font-medium bg-green-50 px-3 py-1 rounded-full border border-green-100">
                      ✅ 计算成功
                    </span>
                  )}
                </div>

                <div className="p-6 flex-1">
                  {!result?.success ? (
                    <div className="h-full flex flex-col items-center justify-center text-slate-400 p-8 text-center">
                      <AlertCircle size={48} className="mb-4 text-slate-300" />
                      <p className="text-lg font-medium text-slate-600 mb-2">计算失败</p>
                      <p className="whitespace-pre-line max-w-md">{result?.error || "请调整原料或目标参数"}</p>
                    </div>
                  ) : (
                    <div className="space-y-8">
                      {/* Summary Cards */}
                      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div className="p-4 bg-blue-50 rounded-lg border border-blue-100">
                          <div className="text-xs text-blue-600 uppercase font-bold mb-1">成品蛋白</div>
                          <div className="text-2xl font-bold text-blue-900">{result.finalStats.protein.toFixed(2)}%</div>
                        </div>
                        <div className="p-4 bg-yellow-50 rounded-lg border border-yellow-100">
                          <div className="text-xs text-yellow-600 uppercase font-bold mb-1">成品脂肪</div>
                          <div className="text-2xl font-bold text-yellow-900">{result.finalStats.fat.toFixed(2)}%</div>
                        </div>
                        <div className="p-4 bg-slate-50 rounded-lg border border-slate-100">
                          <div className="text-xs text-slate-500 uppercase font-bold mb-1">总干物质 (TS)</div>
                          <div className="text-2xl font-bold text-slate-700">{result.finalStats.ts.toFixed(2)}%</div>
                        </div>
                        <div className="p-4 bg-green-50 rounded-lg border border-green-100">
                          <div className="text-xs text-green-600 uppercase font-bold mb-1">预估成本</div>
                          <div className="text-xl font-bold text-green-900">¥{(result.totalCost / targetMass).toFixed(2)}<span className="text-xs font-normal text-green-700">/kg</span></div>
                        </div>
                      </div>

                      {/* Recipe Table */}
                      <div>
                        <h3 className="font-bold text-slate-700 mb-4 flex items-center gap-2">
                          <Save size={18} className="text-slate-400" />
                          生产配料表
                        </h3>
                        <div className="overflow-hidden rounded-lg border border-slate-200">
                          <table className="w-full text-left text-sm">
                            <thead className="bg-slate-100 text-slate-600 font-bold uppercase">
                              <tr>
                                <th className="p-3 w-1/3">原料名称</th>
                                <th className="p-3 text-right">配比 (%)</th>
                                <th className="p-3 text-right">投料量 (kg)</th>
                                <th className="p-3 text-right hidden sm:table-cell">单项成本 (元)</th>
                              </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                              {Object.entries(result.amounts)
                                .sort(([, a], [, b]) => b - a) // Sort by amount desc
                                .map(([id, amount]) => {
                                  const ing = ingredients.find(i => i.id === id);
                                  if (!ing || amount < 0.001) return null;
                                  const percent = (amount / targetMass) * 100;
                                  const cost = amount * ing.cost;
                                  return (
                                    <tr key={id} className="hover:bg-slate-50">
                                      <td className="p-3 font-medium text-slate-700">{ing.name}</td>
                                      <td className="p-3 text-right font-mono text-blue-600">{percent.toFixed(3)}%</td>
                                      <td className="p-3 text-right font-mono font-bold">{amount.toFixed(2)}</td>
                                      <td className="p-3 text-right text-slate-500 hidden sm:table-cell">¥{cost.toFixed(1)}</td>
                                    </tr>
                                  );
                                })}
                              <tr className="bg-slate-50 font-bold text-slate-800">
                                <td className="p-3">合计</td>
                                <td className="p-3 text-right">100.00%</td>
                                <td className="p-3 text-right">{targetMass.toFixed(2)} kg</td>
                                <td className="p-3 text-right hidden sm:table-cell">¥{result.totalCost.toFixed(1)}</td>
                              </tr>
                            </tbody>
                          </table>
                        </div>
                        <div className="mt-4 text-xs text-slate-400">
                          * 注意：理论计算值仅供参考，实际生产请考虑原料损耗及检测误差。非脂乳固体 (MSNF) 估算值: {result.finalStats.msnf.toFixed(2)}%。
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
        )}
      </main>
    </div>
  );
}
