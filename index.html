<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ä¹³å“ç ”å‘è®¡ç®—å™¨ v14.0</title>
    
    <!-- PWA é…ç½® -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#FFFFFF">
    
    <!-- å›¾æ ‡ -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='22' fill='%230052D9'/%3E%3Cpath d='M50 20c-16.57 0-30 13.43-30 30s13.43 30 30 30 30-13.43 30-30-13.43-30-30-30zm0 50c-11.05 0-20-8.95-20-20s8.95-20 20-20 20 8.95 20 20-8.95 20-20 20z'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='22' fill='%230052D9'/%3E%3Cpath d='M50 20c-16.57 0-30 13.43-30 30s13.43 30 30 30 30-13.43 30-30-13.43-30-30-30zm0 50c-11.05 0-20-8.95-20-20s8.95-20 20-20 20 8.95 20 20-8.95 20-20 20z'/%3E%3C/svg%3E">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    
    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 50px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --primary: #0052D9;
            --bg: #F5F7FA;
        }
        body {
            background-color: var(--bg);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Helvetica, sans-serif;
            -webkit-tap-highlight-color: transparent;
            color: #1F2937;
            overscroll-behavior-y: none;
            user-select: none;
        }
        input { user-select: text; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

        .header-glass {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: saturate(180%) blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        }
        
        .pt-safe { padding-top: calc(var(--safe-top) + 10px); }
        .pb-safe { padding-bottom: calc(var(--safe-bottom) + 60px); }
        .tap-active:active { transform: scale(0.96); opacity: 0.8; transition: transform 0.1s; }
        
        .list-row {
            display: flex; align-items: center; background: #fff; border-bottom: 1px solid #F3F4F6;
            padding: 14px 16px; position: relative; transition: background-color 0.2s;
        }
        .list-row:last-child { border-bottom: none; }
        .list-row.locked-bg { background-color: #F9FAFB; }
        .list-row.post-add-bg { background-color: #F0F9FF; border-left: 3px solid #3B82F6; }
        
        .stepper-btn {
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
            background: #F3F4F6; color: #4B5563; border-radius: 12px; font-weight: bold; font-size: 22px; border: none; cursor: pointer;
        }
        .stepper-btn:active { background: #E5E7EB; color: #111827; }
        .stepper-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .input-focus:focus-within { background: #fff; box-shadow: 0 0 0 2px var(--primary); z-index: 10; }
        .cost-bar { position: absolute; bottom: 0; left: 0; height: 3px; background: #10B981; opacity: 0.4; }

        .tab-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-top: 1px solid rgba(0,0,0,0.05);
            display: grid; grid-template-columns: 1fr 1fr 1fr 1fr;
            padding-bottom: env(safe-area-inset-bottom);
            height: calc(60px + env(safe-area-inset-bottom));
            z-index: 50;
        }
        .tab-item {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #9CA3AF; transition: all 0.2s; gap: 2px; cursor: pointer;
        }
        .tab-item.active { color: #0052D9; }
        .tab-item .icon-box { padding: 6px; border-radius: 14px; transition: background 0.2s; }
        .tab-item.active .icon-box { background: #EFF6FF; }
        .tab-item .label { font-size: 11px; font-weight: 600; }

        .chk-round { width: 24px; height: 24px; border-radius: 50%; border: 2px solid #D1D5DB; display: flex; align-items: center; justify-content: center; }
        .chk-round.checked { background: #0052D9; border-color: #0052D9; }
        .chk-round.checked::after { content: ''; width: 10px; height: 6px; border-left: 2px solid white; border-bottom: 2px solid white; transform: rotate(-45deg) translate(1px, -1px); }

        .toast-container {
            position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: rgba(31, 41, 55, 0.9); color: white; padding: 12px 24px; border-radius: 50px;
            font-size: 14px; font-weight: bold; z-index: 100; pointer-events: none;
            opacity: 0; transition: opacity 0.3s; box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            backdrop-filter: blur(4px); text-align: center; white-space: nowrap;
        }
        .toast-show { opacity: 1; }
        
        .toggle-sm { position: relative; width: 36px; height: 20px; background: #E5E7EB; border-radius: 20px; transition: all 0.2s; cursor: pointer; }
        .toggle-sm.checked { background: #0052D9; }
        .toggle-sm::after { content:''; position: absolute; left: 2px; top: 2px; width: 16px; height: 16px; background: white; border-radius: 50%; transition: all 0.2s; }
        .toggle-sm.checked::after { transform: translateX(16px); }

        @keyframes slide-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slide-down { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-up { animation: slide-up 0.3s ease-out; }
        .animate-slide-down { animation: slide-down 0.2s ease-out; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/javascript">
        if ('serviceWorker' in navigator) {
            try {
                const swContent = "self.addEventListener('fetch', (e) => {}); self.addEventListener('install', (e) => { self.skipWaiting(); });";
                const blob = new Blob([swContent], {type: 'text/javascript'});
                const swUrl = URL.createObjectURL(blob);
                navigator.serviceWorker.register(swUrl).catch(e => console.log('SW skipped'));
            } catch(e) {}
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, Fragment } = React;
        const vibrate = () => { if (navigator.vibrate) navigator.vibrate(10); };

        const Icon = ({ d, size = 24, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d={d} />
            </svg>
        );

        const ICONS = {
            Flask: "M10 2v7.527a2 2 0 0 1-.211.896L4.72 20.55a1 1 0 0 0 .9 1.45h12.76a1 1 0 0 0 .9-1.45l-5.069-10.127A2 2 0 0 1 14 9.527V2M8.5 2h7M7 16h10",
            Brain: "M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z M14.5 2A2.5 2.5 0 0 1 17 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 14.5 2Z",
            Tools: "M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z",
            Folder: "M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z",
            Lock: "M7 11V7a5 5 0 0 1 10 0v4M3 11h18v11H3z", 
            Unlock: "M7 11V7a5 5 0 0 1 9.9-1M3 11h18v11H3z", 
            X: "M18 6 6 18M6 6 12 12",
            Plus: "M12 5v14M5 12h14",
            Share: "M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8M16 6l-4-4-4 4M12 2v13",
            Drop: "M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z",
            Trash: "M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M9 9v8M15 9v8",
            Bolt: "M13 2L3 14h9l-1 8 10-12h-9l1-8z",
            Microscope: "M6 18h8M3 22h18M14 22a7 7 0 1 0 0-14h-1M9 14h2M9 12a2 2 0 0 1-2-2V6h6v4a2 2 0 0 1-2 2ZM12 6V3a1 1 0 0 0-1-1H9a1 1 0 0 0-1 1v3",
            Refresh: "M23 4v6h-6M1 20v-6h6M20.49 15a9 9 0 1 1-2.12-9.36L23 10",
            Edit: "M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7M17.5 2.5a2.121 2.121 0 0 1 3 3L11 19H8v-3L17.5 2.5z",
            Target: "M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 16a6 6 0 1 1 6-6 6 6 0 0 1-6 6zm0-9a3 3 0 1 0 3 3 3 3 0 0 0-3-3z",
            Download: "M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3",
            Save: "M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2zM17 21v-8H7v8M7 3v5h8",
            Star: "M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z",
            Wand: "M15 4V2m0 2a10 10 0 1 1 0 20 10 10 0 0 1 0-20z"
        };

        const DEFAULT_INGREDIENTS = [
            { id: 'rm', name: 'ç”Ÿç‰›ä¹³', fat: 3.8, protein: 3.1, ts: 12.5, price: 4.5, sweet: 0, visc: 1.0 },
            { id: 'conc', name: 'æµ“ç¼©å¥¶', fat: 8.0, protein: 7.0, ts: 26.0, price: 9.0, sweet: 0, visc: 2.5 },
            { id: 'cr', name: 'ç¨€å¥¶æ²¹38', fat: 38.0, protein: 2.2, ts: 45.0, price: 35.0, sweet: 0, visc: 1.2 },
            { id: 'smp', name: 'è„±è„‚ç²‰', fat: 0.8, protein: 34.0, ts: 96.0, price: 28.0, sweet: 0, visc: 5.0 },
            { id: 'wmp', name: 'å…¨è„‚ç²‰', fat: 26.0, protein: 24.0, ts: 96.0, price: 32.0, sweet: 0, visc: 4.5 },
            { id: 'wpc', name: 'WPC80', fat: 6.0, protein: 80.0, ts: 95.0, price: 65.0, sweet: 0, visc: 8.0 },
            { id: 'suc', name: 'ç™½ç ‚ç³–', fat: 0.0, protein: 0.0, ts: 99.8, price: 6.5, sweet: 1.0, visc: 0.5 },
            { id: 'ery', name: 'èµ¤è—“ç³–é†‡', fat: 0.0, protein: 0.0, ts: 99.0, price: 15.0, sweet: 0.65, visc: 0.2 },
            { id: 'stab', name: 'å¤é…ç¨³å®šå‰‚', fat: 0.0, protein: 0.0, ts: 95.0, price: 45.0, sweet: 0, visc: 100.0 },
            { id: 'jam', name: 'æœé…±', fat: 0.0, protein: 0.3, ts: 45.0, price: 12.0, sweet: 0.4, isPost: true, visc: 20.0 },
            { id: 'wat', name: 'å·¥è‰ºæ°´', fat: 0.0, protein: 0.0, ts: 0.0, price: 0.005, sweet: 0, visc: 0 },
        ];

        const Toast = ({ msg, visible }) => (
            <div className={`toast-container ${visible ? 'toast-show' : ''}`}>{msg}</div>
        );

        const NumInput = ({ label, value, onChange, suffix, enabled, onToggle, className }) => (
            <div className={`bg-gray-50 rounded-xl p-3 flex flex-col justify-center border transition-colors ${enabled===false ? 'opacity-50 border-gray-100' : 'border-blue-100 bg-white'} ${className || ''}`}>
                <div className="flex justify-between items-center mb-1">
                    <div className="text-[10px] text-gray-400 font-bold uppercase">{label}</div>
                    {onToggle && (
                        <div className={`w-8 h-4 rounded-full relative transition-colors cursor-pointer ${enabled ? 'bg-blue-500' : 'bg-gray-300'}`} onClick={(e) => { e.stopPropagation(); onToggle(); }}>
                            <div className={`w-3 h-3 bg-white rounded-full absolute top-0.5 transition-transform ${enabled ? 'left-[18px]' : 'left-[2px]'}`}></div>
                        </div>
                    )}
                </div>
                <div className="flex items-center">
                    <input type="number" value={value} onChange={onChange} disabled={enabled===false} className="w-full bg-transparent font-mono text-2xl font-bold outline-none text-gray-800" placeholder="0" />
                    {suffix && <span className="text-xs text-gray-400 ml-1">{suffix}</span>}
                </div>
            </div>
        );

        const StepperInput = ({ value, onChange, disabled }) => {
            const handleStep = (delta) => {
                if (disabled) return;
                vibrate();
                const safeVal = parseFloat(value) || 0;
                onChange({ target: { value: Math.max(0, safeVal + delta).toFixed(1) } });
            };
            return (
                <div className={`flex items-center gap-1 h-12 rounded-xl ${disabled ? '' : 'bg-blue-50/50 input-focus'}`}>
                    <button onClick={(e) => {e.stopPropagation(); handleStep(-1)}} disabled={disabled} className="stepper-btn">âˆ’</button>
                    <input type="number" value={value} disabled={disabled} onChange={onChange} className={`flex-1 text-center font-mono text-xl font-bold bg-transparent outline-none ${disabled ? 'text-gray-400' : ''}`} />
                    <button onClick={(e) => {e.stopPropagation(); handleStep(1)}} disabled={disabled} className="stepper-btn">+</button>
                </div>
            );
        };

        const App = () => {
            // --- State ---
            const [activeTab, setActiveTab] = useState('ai'); 
            
            const [library, setLibrary] = useState(() => JSON.parse(localStorage.getItem('v14_lib')) || DEFAULT_INGREDIENTS);
            const [formula, setFormula] = useState(() => JSON.parse(localStorage.getItem('v14_formula')) || [{...DEFAULT_INGREDIENTS[0], uuid:'1', weight:850, locked:false}, {...DEFAULT_INGREDIENTS[1], uuid:'2', weight:150, locked:false}]);
            const [targets, setTargets] = useState(() => JSON.parse(localStorage.getItem('v14_targets')) || {fat:3.5, pro:3.0, ts:12.0, se: 7.0, enableTs: true, enableSe: true});
            const [batchSize, setBatchSize] = useState(() => parseFloat(localStorage.getItem('v14_batch')) || 1000);
            const [productMode, setProductMode] = useState(() => localStorage.getItem('v14_pmode') || 'liquid');
            const [savedRecipes, setSavedRecipes] = useState(() => JSON.parse(localStorage.getItem('v14_recipes')) || []);
            
            const [viewMode, setViewMode] = useState('calc'); 
            const [isLocked, setIsLocked] = useState(false);
            const [baseView, setBaseView] = useState(true);
            const [showAdd, setShowAdd] = useState(false);
            const [editId, setEditId] = useState(null);
            const [toast, setToast] = useState({ show: false, msg: '' });
            const [isSolving, setIsSolving] = useState(false);
            const [genSelected, setGenSelected] = useState([]);

            // Tools Data
            const [fossReadings, setFossReadings] = useState(() => JSON.parse(localStorage.getItem('v14_foss')) || { fat: 0, protein: 0, ts: 0 });
            const [acidity, setAcidity] = useState(() => JSON.parse(localStorage.getItem('v14_acidity')) || { t: 70 });
            const [cultureCalc, setCultureCalc] = useState(() => JSON.parse(localStorage.getItem('v14_culture')) || { dcuPerTon: 50, pouchSize: 50, pouchWeight: 10 });

            useEffect(() => {
                localStorage.setItem('v14_lib', JSON.stringify(library));
                localStorage.setItem('v14_formula', JSON.stringify(formula));
                localStorage.setItem('v14_targets', JSON.stringify(targets));
                localStorage.setItem('v14_batch', batchSize);
                localStorage.setItem('v14_recipes', JSON.stringify(savedRecipes));
                localStorage.setItem('v14_pmode', productMode);
                localStorage.setItem('v14_foss', JSON.stringify(fossReadings));
                localStorage.setItem('v14_acidity', JSON.stringify(acidity));
                localStorage.setItem('v14_culture', JSON.stringify(cultureCalc));
            }, [library, formula, targets, batchSize, savedRecipes, productMode, fossReadings, acidity, cultureCalc]);

            const showToast = (msg) => { setToast({ show: true, msg }); setTimeout(() => setToast({ show: false, msg: '' }), 2000); };
            const isYogurt = productMode === 'yogurt';
            
            const res = useMemo(() => {
                let W=0, F=0, P=0, T=0, C=0, S=0, V=0;
                formula.forEach(i => {
                    const w = parseFloat(i.weight)||0;
                    W+=w; F+=w*(i.fat||0); P+=w*(i.protein||0); T+=w*(i.ts||0); C+=w*(i.price||0); S+=w*(i.sweet||0); V+=w*(i.visc||0);
                });
                const sW = W || 1;
                return { w: W, fat: F/sW, pro: P/sW, ts: T/sW, pf: F>0?P/F:0, cost: C, costPerKg: C/sW, se: S/sW, tex: V/sW };
            }, [formula]);

            const updateItem = (uuid, k, v) => setFormula(formula.map(i => i.uuid===uuid ? {...i, [k]: v} : i));
            const delItem = (uuid) => { vibrate(); setFormula(formula.filter(i => i.uuid!==uuid)); };
            const addItem = (item) => { vibrate(); setFormula([...formula, {...item, uuid: Date.now().toString(), weight:0}]); setShowAdd(false); showToast("å·²æ·»åŠ "); };
            
            const normalize = () => {
                vibrate();
                if(res.w === 0) return;
                const r = batchSize / res.w;
                setFormula(formula.map(i => {
                    if (isYogurt && baseView && i.isPost) return i; 
                    return {...i, weight: parseFloat((i.weight*r).toFixed(2))};
                }));
                showToast("å·²å½’ä¸€åŒ–");
            };

            const balanceWater = () => {
                vibrate();
                let wIdx = formula.findIndex(i => i.id === 'wat');
                if (wIdx === -1) wIdx = formula.findIndex(i => i.name.includes('æ°´'));
                if (wIdx === -1) {
                    const waterLib = library.find(i => i.id === 'wat') || { id: 'wat', name: 'å·¥è‰ºæ°´', fat:0, protein:0, ts:0, price:0.005, sweet:0, visc:0 };
                    const newWater = { ...waterLib, uuid: Date.now().toString(), weight: 0 };
                    const newF = [...formula, newWater];
                    const activeF = (isYogurt && baseView) ? newF.filter(i => !i.isPost) : newF;
                    const others = activeF.reduce((acc, i) => i.uuid !== newWater.uuid ? acc+(parseFloat(i.weight)||0) : acc, 0);
                    const need = batchSize - others;
                    if (need < 0) { setFormula(newF); return showToast(`å·²æ·»æ°´,ä½†è¶…é‡ ${Math.abs(need).toFixed(1)}g`); }
                    newF[newF.length-1].weight = parseFloat(need.toFixed(2));
                    setFormula(newF);
                    return showToast("è‡ªåŠ¨è¡¥æ°´å®Œæˆ");
                }
                if (isYogurt && baseView && formula[wIdx].isPost) return showToast("æ°´ä¸ºåæ·»åŠ ï¼Œè¯·åˆ‡æˆå“æ¨¡å¼");
                const activeF = (isYogurt && baseView) ? formula.filter(i => !i.isPost) : formula;
                const others = activeF.reduce((acc, i, idx) => i.uuid!==formula[wIdx].uuid ? acc+(parseFloat(i.weight)||0) : acc, 0);
                const need = batchSize - others;
                if (need < 0) return showToast(`è¶…é‡ ${Math.abs(need).toFixed(1)}g`);
                const newF = [...formula]; newF[wIdx].weight = parseFloat(need.toFixed(2));
                setFormula(newF);
                showToast("è¡¥æ°´å®Œæˆ");
            };

            const copyReport = () => {
                const txt = `é…æ–¹\n--------\n` + formula.map(i=>`${i.name}: ${i.weight}g`).join('\n') + `\n--------\næ€»:${res.w.toFixed(1)}g\nF:${res.fat.toFixed(2)}% P:${res.pro.toFixed(2)}%`;
                navigator.clipboard.writeText(txt).then(()=>showToast("å·²å¤åˆ¶"));
            };
            
            const calcCultureWeight = () => { 
                const batchInTon = batchSize / 1000000; 
                const totalDCU = batchInTon * cultureCalc.dcuPerTon; 
                const pouches = totalDCU / cultureCalc.pouchSize;
                const grams = pouches * cultureCalc.pouchWeight;
                return grams.toFixed(2);
            };

            // --- Auto Pilot Algorithm (Heuristic + Optimization) ---
            const runAutoPilot = () => {
                vibrate();
                setIsSolving(true);
                
                // 1. Determine Ingredients Pool
                let pool = [];
                
                // If user manually selected, use those
                if (genSelected.length > 0) {
                    pool = genSelected.map(id => library.find(l => l.id === id)).filter(Boolean);
                } else {
                    // AUTO-RECOMMENDATION LOGIC
                    // Add base
                    pool.push(library.find(i => i.id === 'rm') || library[0]);
                    
                    // Need Fat?
                    if (targets.fat > 3.5) {
                        const fatIng = library.find(i => i.id === 'cr') || library.find(i => i.fat > 30);
                        if (fatIng) pool.push(fatIng);
                    }
                    
                    // Need Protein?
                    if (targets.pro > 3.1) {
                        // Prioritize WPC for efficiency, SMP for bulk
                        const proteinIng = library.find(i => i.id === 'wpc') || library.find(i => i.protein > 50);
                        if (proteinIng) pool.push(proteinIng);
                        if (targets.ts > 12) {
                            const smpIng = library.find(i => i.id === 'smp');
                            if (smpIng) pool.push(smpIng);
                        }
                    }
                    
                    // Need Sweetness?
                    if (isYogurt && targets.se > 0 && targets.enableSe) {
                        const sweetIng = library.find(i => i.id === 'suc');
                        if (sweetIng) pool.push(sweetIng);
                    }
                    
                    // Stabilizer?
                    if (isYogurt) {
                        const stabIng = library.find(i => i.id === 'stab');
                        if (stabIng) pool.push(stabIng);
                    }
                    
                    // Dedupe and clean
                    pool = [...new Set(pool.filter(Boolean).map(p => JSON.stringify(p)))].map(p => JSON.parse(p));
                }

                setTimeout(() => {
                    const targetW = batchSize;
                    
                    // 2. Run Optimizer
                    let bestWeights = pool.map(() => 0);
                    let minError = Infinity;
                    
                    // Initialize random weights
                    for (let k = 0; k < 5000; k++) {
                         let rands = pool.map(() => Math.random());
                         let sumR = rands.reduce((a,b)=>a+b, 0);
                         let currentWs = rands.map(r => (r/sumR) * targetW);
                         
                         // Calc
                         let cF=0, cP=0, cTS=0, cSE=0;
                         pool.forEach((item, idx) => {
                             let w = currentWs[idx];
                             cF += w * (item.fat||0); 
                             cP += w * (item.protein||0); 
                             cTS += w * (item.ts||0); 
                             cSE += w * (item.sweet||0);
                         });
                         
                         const fVal = (cF/targetW)*100;
                         const pVal = (cP/targetW)*100;
                         const tsVal = (cTS/targetW)*100;
                         const seVal = (cSE/targetW)*100;
                         
                         let err = Math.abs(fVal - targets.fat)*10 + Math.abs(pVal - targets.pro)*10;
                         if (targets.enableTs) err += Math.abs(tsVal - targets.ts)*2;
                         if (isYogurt && targets.enableSe) err += Math.abs(seVal - targets.se)*3;
                         
                         if(err < minError) {
                             minError = err;
                             bestWeights = currentWs;
                         }
                    }
                    
                    // 3. Generate & Clean Recipe
                    const newF = pool.map((item, idx) => ({
                        ...item,
                        uuid: Math.random().toString(36).substr(2,9),
                        weight: parseFloat(bestWeights[idx].toFixed(2)),
                        locked: false
                    })).filter(i => i.weight > 0.1); // Filter out tiny amounts

                    setFormula(newF);
                    setGenSelected([]);
                    setIsSolving(false);
                    setActiveTab('recipe');
                    showToast("é…æ–¹å·²ç”Ÿæˆ");
                }, 800);
            };

            const handleSave = () => {
                vibrate();
                const nextNum = savedRecipes.length + 1;
                const name = `é…æ–¹${nextNum}`;
                const newRecipe = { id: Date.now(), name, formula, targets, batchSize, productMode, date: new Date().toLocaleDateString() };
                setSavedRecipes([newRecipe, ...savedRecipes]);
                showToast(`å·²ä¿å­˜: ${name}`);
            };

            const handleRename = (id) => {
                const r = savedRecipes.find(r => r.id === id);
                const newName = prompt("ä¿®æ”¹åç§°", r.name);
                if (newName) setSavedRecipes(savedRecipes.map(r => r.id === id ? { ...r, name: newName } : r));
            };
            
            const handleDeleteRecipe = (id) => {
                if(confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) { setSavedRecipes(savedRecipes.filter(r => r.id !== id)); showToast("å·²åˆ é™¤"); }
            };
            
            const handleLoadRecipe = (r) => {
                 if(confirm(`åŠ è½½ "${r.name}"?`)) {
                    setFormula(r.formula); setTargets(r.targets); setBatchSize(r.batchSize); if(r.productMode) setProductMode(r.productMode); setActiveTab('recipe'); showToast("å·²è¯»å–");
                 }
            };

            // Renders
            const renderAI = () => (
                <div className="space-y-6 animate-slide-up pb-24">
                    <div className="bg-white rounded-3xl p-6 shadow-sm border border-gray-100">
                        <h3 className="font-bold text-gray-900 mb-4 flex items-center gap-2 text-lg"><Icon d={ICONS.Target} size={20} className="text-blue-600"/> ç›®æ ‡è®¾å®š</h3>
                        <div className="grid grid-cols-2 gap-4 mb-6">
                            <NumInput label="è„‚è‚ª FAT%" value={targets.fat} onChange={e=>setTargets({...targets, fat:parseFloat(e.target.value)||0})} />
                            <NumInput label="è›‹ç™½ PRO%" value={targets.pro} onChange={e=>setTargets({...targets, pro:parseFloat(e.target.value)||0})} />
                            <NumInput label="æ€»å›º TS%" value={targets.ts} onChange={e=>setTargets({...targets, ts:parseFloat(e.target.value)||0})} enabled={targets.enableTs} onToggle={()=>setTargets({...targets, enableTs:!targets.enableTs})} />
                            {isYogurt && <NumInput label="ç”œåº¦ SE" value={targets.se} onChange={e=>setTargets({...targets, se:parseFloat(e.target.value)||0})} enabled={targets.enableSe} onToggle={()=>setTargets({...targets, enableSe:!targets.enableSe})} />}
                        </div>
                        <div className="text-xs text-gray-500 mb-3 font-bold">é€‰æ‹©åŸæ–™æ±  (å¯é€‰):</div>
                        <div className="grid grid-cols-3 gap-3 mb-6">
                            {library.map(ing => (
                                <div key={ing.id} onClick={() => {vibrate(); setGenSelected(prev => prev.includes(ing.id)?prev.filter(i=>i!==ing.id):[...prev,ing.id])}} 
                                     className={`p-3 rounded-xl text-xs font-bold text-center transition-all border cursor-pointer ${genSelected.includes(ing.id)?'bg-purple-50 border-purple-200 text-purple-700':'bg-gray-50 border-gray-200 text-gray-600'}`}>
                                    {ing.name}
                                </div>
                            ))}
                        </div>
                        <button onClick={runAutoPilot} disabled={isSolving} className="w-full h-14 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-2xl font-bold flex items-center justify-center gap-2 disabled:opacity-60 transition-all active:scale-95">
                            <Icon d={ICONS.Wand} size={22}/> {isSolving?'AI è®¡ç®—ä¸­...':(genSelected.length>0 ? 'ç”ŸæˆæŒ‡å®šé…æ–¹' : 'ğŸš€ AI è‡ªåŠ¨æ¨èé…æ–¹')}
                        </button>
                        <p className="text-[10px] text-gray-400 text-center mt-3">ä¸é€‰åŸæ–™æ—¶ï¼ŒAI å°†è‡ªåŠ¨åŒ¹é…æœ€ä½³ç»„åˆ</p>
                    </div>
                </div>
            );

            const renderRecipe = () => (
                <div className="space-y-4 animate-slide-up pb-24">
                    <div className="flex justify-between items-center px-1">
                         <div className="flex items-center gap-2 bg-white rounded-lg p-1 border border-gray-100">
                             <button onClick={()=>setViewMode('calc')} className={`text-xs px-3 py-1.5 rounded-md font-bold transition-all ${viewMode==='calc'?'bg-gray-100 text-blue-600':'text-gray-400'}`}>è®¡ç®—</button>
                             <button onClick={()=>setViewMode('cost')} className={`text-xs px-3 py-1.5 rounded-md font-bold transition-all ${viewMode==='cost'?'bg-gray-100 text-green-600':'text-gray-400'}`}>æˆæœ¬</button>
                         </div>
                         <button onClick={balanceWater} className="flex items-center gap-1 text-xs font-bold text-blue-600 bg-blue-50 px-3 py-2 rounded-lg active:scale-95 transition-transform"><Icon d={ICONS.Drop} size={16}/> è¡¥æ°´</button>
                    </div>
                    <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                        {formula.length === 0 ? <div className="p-10 text-center text-gray-400 text-sm">æš‚æ— åŸæ–™ï¼Œè¯·å»æ™ºèƒ½é¡µç”Ÿæˆ</div> : formula.map(item => {
                            if (isYogurt && baseView && item.isPost) return null;
                            return (
                                <div key={item.uuid} className={`list-row ${item.locked?'locked-bg':''} ${item.isPost?'post-add-bg':''}`} onClick={() => setEditId(editId===item.uuid?null:item.uuid)}>
                                    <div className="flex items-center gap-3 w-28">
                                        <button onClick={(e) => {e.stopPropagation(); updateItem(item.uuid, 'locked', !item.locked); vibrate();}} className={`text-gray-300 transition-colors ${item.locked?'text-blue-600':'text-gray-300'}`}>
                                            <Icon d={item.locked ? ICONS.Lock : ICONS.Unlock} size={16}/>
                                        </button>
                                        <div className="flex-1">
                                            <div className={`font-bold text-sm truncate ${item.locked?'text-gray-500':'text-gray-800'}`}>{item.name}{item.isPost && <span className="text-[8px] bg-purple-100 text-purple-600 px-1 rounded ml-1">ååŠ </span>}</div>
                                            <div className="text-[9px] text-gray-400 font-mono mt-0.5">F{(item.fat||0).toFixed(1)} P{(item.protein||0).toFixed(1)}</div>
                                        </div>
                                    </div>
                                    <div className="flex-1 px-2"><StepperInput value={item.weight} disabled={item.locked} onChange={(e) => !item.locked && updateItem(item.uuid, 'weight', parseFloat(e.target.value)||0)} /></div>
                                    <div className="w-16 flex flex-col items-end justify-center relative pl-1">
                                        <div className="font-bold text-xs text-gray-700 font-mono">{viewMode==='cost' ? `Â¥${(item.price||0).toFixed(1)}` : (res.w>0?(item.weight/res.w*100).toFixed(1)+'%':'0%')}</div>
                                        <button onClick={(e)=>{e.stopPropagation(); delItem(item.uuid)}} className="text-gray-300 p-1 hover:text-red-500"><Icon d={ICONS.X} size={14}/></button>
                                        {viewMode==='cost' && <div className="cost-bar" style={{width: `${(item.weight*(item.price||0))/(res.cost||1)*100}%`}}></div>}
                                    </div>
                                    {editId === item.uuid && (
                                        <div className="w-full pt-3 pb-1 animate-slide-down border-t border-gray-50 mt-2" onClick={e=>e.stopPropagation()}>
                                            <div className="flex justify-between mb-2 px-1">
                                                {isYogurt && <button onClick={()=>updateItem(item.uuid,'isPost',!item.isPost)} className="text-xs bg-purple-50 px-3 py-1.5 rounded-lg text-purple-600 font-bold">ååŠ : {item.isPost?'æ˜¯':'å¦'}</button>}
                                                <button onClick={() => copyReport()} className="text-xs bg-gray-50 px-3 py-1.5 rounded-lg text-gray-600 font-bold">å¤åˆ¶</button>
                                            </div>
                                            <div className="grid grid-cols-4 gap-2">
                                                {['fat','protein','ts','price'].map(k=><div key={k} className="bg-gray-50 p-1 rounded text-center"><div className="text-[8px] text-gray-400 uppercase">{k.substring(0,3)}</div><div className="text-sm font-bold text-gray-800">{(item[k]||0).toFixed(1)}</div></div>)}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            );
                        })}
                    </div>
                    <div className="bg-white rounded-2xl p-4 shadow-sm border border-gray-100 grid grid-cols-4 gap-2 text-center mt-4">
                         <div><div className="text-[10px] text-gray-400 font-bold">FAT</div><div className="text-lg font-black text-gray-800">{res.fat.toFixed(2)}</div></div>
                         <div><div className="text-[10px] text-gray-400 font-bold">PRO</div><div className="text-lg font-black text-gray-800">{res.pro.toFixed(2)}</div></div>
                         <div><div className="text-[10px] text-gray-400 font-bold">TS</div><div className="text-lg font-black text-gray-800">{res.ts.toFixed(2)}</div></div>
                         <div><div className="text-[10px] text-gray-400 font-bold">æˆæœ¬</div><div className="text-lg font-black text-green-600">Â¥{res.costPerKg.toFixed(1)}</div></div>
                    </div>
                    <button onClick={() => { vibrate(); setShowAdd(true); }} className="mt-4 w-full h-12 rounded-2xl border-2 border-dashed border-blue-200 text-blue-500 font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform"><Icon d={ICONS.Plus} size={20}/> æ·»åŠ åŸæ–™</button>
                </div>
            );

            const renderTools = () => (
                <div className="grid grid-cols-2 gap-3 animate-slide-up pb-24">
                    <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 cursor-pointer active:scale-95 transition-transform" onClick={()=>alert(`éœ€ç§°å–èŒç§: ${calcCultureWeight()}g`)}>
                        <div className="w-10 h-10 bg-green-50 text-green-600 rounded-xl flex items-center justify-center mb-2"><Icon d={ICONS.Microscope} size={24}/></div>
                        <div className="font-bold text-sm text-gray-800">èŒç§è®¡ç®—</div>
                        <div className="text-[10px] text-gray-400 mt-1">ç‚¹å‡»è®¡ç®—æ·»åŠ é‡</div>
                    </div>
                    <div className="bg-white p-4 rounded-2xl shadow-sm border border-gray-100 cursor-pointer">
                        <div className="w-10 h-10 bg-orange-50 text-orange-600 rounded-xl flex items-center justify-center mb-2"><Icon d={ICONS.Flask} size={24}/></div>
                        <div className="font-bold text-sm text-gray-800">é…¸åº¦æ¢ç®—</div>
                        <div className="text-[10px] text-gray-400 mt-1">{(acidity.t||70).toFixed(1)}Â°T â‰ˆ {((acidity.t||70)*0.009).toFixed(2)}%</div>
                    </div>
                    <div className="col-span-2 bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                        <h3 className="font-bold text-sm text-gray-800 mb-3">FOSS éªŒè¯</h3>
                        <div className="grid grid-cols-3 gap-2">
                            {['fat','protein','ts'].map(k=><NumInput key={k} label={k.toUpperCase()} value={fossReadings[k]} onChange={e=>setFossReadings({...fossReadings, [k]:parseFloat(e.target.value)||0})} />)}
                        </div>
                    </div>
                </div>
            );

            const renderFiles = () => (
                <div className="space-y-4 animate-slide-up pb-24">
                     <div className="bg-blue-600 text-white rounded-3xl p-6 shadow-lg flex items-center justify-between active:scale-95 transition-transform cursor-pointer" onClick={handleSave}>
                         <div><div className="font-bold text-xl">ä¸€é”®ä¿å­˜å½“å‰</div><div className="text-blue-200 text-xs mt-1">è‡ªåŠ¨å‘½åä¸º é…æ–¹{savedRecipes.length+1}</div></div>
                         <div className="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center"><Icon d={ICONS.Save} size={24}/></div>
                     </div>
                     <div className="bg-white rounded-3xl p-5 shadow-sm min-h-[300px]">
                         <h3 className="font-bold text-gray-900 mb-4 ml-1">å†å²å­˜æ¡£ ({savedRecipes.length})</h3>
                         {savedRecipes.length===0 && <div className="text-center text-gray-300 py-12">æš‚æ— å­˜æ¡£</div>}
                         {savedRecipes.map(r => (
                             <div key={r.id} className="flex justify-between items-center p-4 bg-gray-50 rounded-2xl mb-3 border border-gray-100">
                                 <div className="flex-1">
                                     <div className="font-bold text-gray-800 text-lg flex items-center gap-2">{r.name} <button onClick={(e)=>{e.stopPropagation(); handleRename(r.id)}} className="text-[10px] text-gray-400 hover:text-blue-600"><Icon d={ICONS.Edit} size={14}/></button></div>
                                     <div className="text-[10px] text-gray-400 mt-1 font-mono">{r.date}</div>
                                 </div>
                                 <div className="flex gap-3 items-center">
                                     <button onClick={() => handleLoadRecipe(r)} className="text-xs bg-white border border-gray-200 px-4 py-2 rounded-xl font-bold text-blue-600 shadow-sm active:scale-95 transition-transform">è¯»å–</button>
                                     <button onClick={(e)=>{e.stopPropagation(); handleDeleteRecipe(r.id)}} className="text-gray-300 hover:text-red-500 cursor-pointer"><Icon d={ICONS.Trash} size={18}/></button>
                                 </div>
                             </div>
                         ))}
                     </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-[#F0F2F5]">
                    <Toast msg={toast.msg} visible={toast.show} />
                    <header className="fixed top-0 left-0 right-0 z-50 header-glass pt-safe pb-3 px-4">
                        <div className="flex justify-between items-center h-10">
                            <div className="flex bg-gray-100 rounded-lg p-0.5">
                                <button onClick={()=>{vibrate();setProductMode('liquid')}} className={`px-4 py-1.5 text-xs font-bold rounded-md transition-all ${!isYogurt?'bg-white shadow text-blue-600':'text-gray-500'}`}>ä¹³é¥®</button>
                                <button onClick={()=>{vibrate();setProductMode('yogurt')}} className={`px-4 py-1.5 text-xs font-bold rounded-md transition-all ${isYogurt?'bg-white shadow text-purple-600':'text-gray-500'}`}>é…¸å¥¶</button>
                            </div>
                            <div className={`flex items-center bg-gray-100 rounded-lg px-3 h-9 transition-colors ${isLocked ? 'opacity-60' : ''} w-32`}>
                                <input type="number" value={batchSize} disabled={isLocked} onChange={e => setBatchSize(parseFloat(e.target.value)||1000)} className="bg-transparent flex-1 font-mono font-bold text-xs outline-none" placeholder="1000" />
                                <span className="text-xs font-bold text-gray-400 ml-1">g</span>
                                <button onClick={() => { vibrate(); setIsLocked(!isLocked); }} className="ml-2 text-gray-400"><Icon d={isLocked ? ICONS.Lock : ICONS.Unlock} size={14}/></button>
                            </div>
                            <button onClick={normalize} className="h-9 w-9 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center tap-active shadow-sm border border-blue-100 font-bold active:scale-90 transition-transform"><Icon d={ICONS.Refresh} size={16}/></button>
                        </div>
                    </header>

                    <div className="pt-[80px] px-3">
                        {activeTab === 'ai' && renderAI()}
                        {activeTab === 'recipe' && renderRecipe()}
                        {activeTab === 'tools' && renderTools()}
                        {activeTab === 'files' && renderFiles()}
                    </div>

                    <div className="tab-bar">
                        <div className={`tab-item ${activeTab==='ai'?'active':''}`} onClick={() => {vibrate(); setActiveTab('ai')}}><div className="icon-box"><Icon d={ICONS.Brain} size={24}/></div><span className="label">æ™ºèƒ½</span></div>
                        <div className={`tab-item ${activeTab==='recipe'?'active':''}`} onClick={() => {vibrate(); setActiveTab('recipe')}}><div className="icon-box"><Icon d={ICONS.Flask} size={24}/></div><span className="label">é…æ–¹</span></div>
                        <div className={`tab-item ${activeTab==='tools'?'active':''}`} onClick={() => {vibrate(); setActiveTab('tools')}}><div className="icon-box"><Icon d={ICONS.Tools} size={24}/></div><span className="label">å·¥å…·</span></div>
                        <div className={`tab-item ${activeTab==='files'?'active':''}`} onClick={() => {vibrate(); setActiveTab('files')}}><div className="icon-box"><Icon d={ICONS.Folder} size={24}/></div><span className="label">å­˜æ¡£</span></div>
                    </div>

                    {showAdd && (
                        <div className="fixed inset-0 z-[60] bg-black/30 backdrop-blur-sm flex items-end" onClick={() => setShowAdd(false)}>
                            <div className="bg-white w-full rounded-t-2xl p-4 h-[60vh] overflow-y-auto" onClick={e=>e.stopPropagation()}>
                                <div className="font-bold text-lg mb-4 text-center text-gray-800">åŸæ–™åº“</div>
                                <div className="grid grid-cols-2 gap-3">{library.map(ing => (<div key={ing.id} onClick={() => addItem(ing)} className="p-3 bg-gray-50 rounded-xl tap-active border border-gray-200 text-center font-bold text-sm text-gray-700"><div>{ing.name}</div><div className="text-[10px] text-gray-400 mt-1">F{(ing.fat||0).toFixed(1)} P{(ing.protein||0).toFixed(1)}</div></div>))}</div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
