<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>‰π≥ÂìÅÁ†îÂèëËÆ°ÁÆóÂô® Pro Max</title>
    
    <!-- PWA ÈÖçÁΩÆ -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#FFFFFF">
    
    <!-- ÂõæÊ†á -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='22' fill='%230052D9'/%3E%3Cpath d='M50 20 C50 20 30 50 30 70 A20 20 0 0 0 70 70 C70 50 50 20 50 20 Z' fill='white'/%3E%3C/svg%3E">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='22' fill='%230052D9'/%3E%3Cpath d='M50 20 C50 20 30 50 30 70 A20 20 0 0 0 70 70 C70 50 50 20 50 20 Z' fill='white'/%3E%3C/svg%3E">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    
    <style>
        :root {
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
            --primary: #0052D9;
            --bg: #F0F2F5; /* ËÉåÊôØÁ®çÂæÆÂä†Ê∑±ÔºåÁ™ÅÊòæÂç°Áâá */
        }
        body {
            background-color: var(--bg);
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Helvetica, sans-serif;
            -webkit-tap-highlight-color: transparent;
            color: #1F2937;
            overscroll-behavior-y: none;
            user-select: none;
        }
        input { user-select: text; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }

        .header-glass {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: saturate(180%) blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.08);
            box-shadow: 0 4px 12px rgba(0,0,0,0.03);
        }
        
        .pt-safe { padding-top: calc(var(--safe-top) + 4px); }
        .pb-safe { padding-bottom: calc(var(--safe-bottom) + 10px); }
        .tap-active:active { transform: scale(0.96); opacity: 0.8; transition: transform 0.1s; }
        
        .stat-capsule {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-right: 1px solid #E5E7EB;
            position: relative;
            padding: 8px 0;
        }
        .stat-capsule:last-child { border-right: none; }
        
        .list-row {
            display: flex;
            align-items: center;
            background: #fff;
            border-bottom: 1px solid #F3F4F6;
            padding: 12px 14px; 
            position: relative;
            transition: background-color 0.2s;
        }
        /* ÈîÅÂÆöÁä∂ÊÄÅÊ†∑Âºè */
        .list-row.locked-bg {
            background-color: #F9FAFB;
        }
        
        /* Ê≠•ËøõÂô®Ê†∑Âºè‰ºòÂåñ */
        .stepper-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #F3F4F6;
            color: #4B5563;
            border-radius: 10px;
            font-weight: bold;
            font-size: 20px;
            transition: all 0.1s;
        }
        .stepper-btn:active:not(:disabled) { background: #E5E7EB; color: #111827; }
        .stepper-btn:disabled { opacity: 0.3; cursor: not-allowed; background: #F3F4F6; color: #9CA3AF; }
        
        .input-focus:focus-within { background: #fff; box-shadow: 0 0 0 2px var(--primary); z-index: 10; }
        
        /* ÊàêÊú¨Êù° */
        .cost-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: #10B981;
            opacity: 0.4;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/javascript">
        if ('serviceWorker' in navigator) {
            try {
                const swContent = "self.addEventListener('fetch', (e) => {}); self.addEventListener('install', (e) => { self.skipWaiting(); });";
                const blob = new Blob([swContent], {type: 'text/javascript'});
                const swUrl = URL.createObjectURL(blob);
                navigator.serviceWorker.register(swUrl).catch(e => console.log('SW skipped'));
            } catch(e) {}
        }
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, Fragment } = React;
        const vibrate = () => { if (navigator.vibrate) navigator.vibrate(10); };

        // Icons
        const Icon = ({ d, size = 18, className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d={d} /></svg>
        );
        const ICONS = {
            Lock: "M7 11V7a5 5 0 0 1 10 0v4M3 11h18v11H3z", 
            Unlock: "M7 11V7a5 5 0 0 1 9.9-1M3 11h18v11H3z", 
            X: "M18 6 6 18M6 6 12 12",
            Plus: "M12 5v14M5 12h14",
            Target: "M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 16a6 6 0 1 1 6-6 6 6 0 0 1-6 6z",
            Share: "M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8M16 6l-4-4-4 4M12 2v13",
            Wand: "M15 4V2M15 16v-2M8 9h2M20 9h2M17.8 11.8 19 13M12 5l-2-2M12 13l-2 2M2 2l20 20",
            Drop: "M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z",
            Trash: "M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",
            Folder: "M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z",
            Refresh: "M23 4v6h-6M1 20v-6h6M20.49 15a9 9 0 1 1-2.12-9.36L23 10"
        };

        const DEFAULT_INGREDIENTS = [
            { id: 'rm', name: 'ÁîüÁâõ‰π≥', fat: 3.8, protein: 3.1, ts: 12.5, price: 4.5 },
            { id: 'cr', name: 'Á®ÄÂ•∂Ê≤π38', fat: 38.0, protein: 2.2, ts: 45.0, price: 35.0 },
            { id: 'smp', name: 'ËÑ±ËÑÇÁ≤â', fat: 0.8, protein: 34.0, ts: 96.0, price: 28.0 },
            { id: 'wmp', name: 'ÂÖ®ËÑÇÁ≤â', fat: 26.0, protein: 24.0, ts: 96.0, price: 32.0 },
            { id: 'wpc', name: 'WPC80', fat: 6.0, protein: 80.0, ts: 95.0, price: 65.0 },
            { id: 'suc', name: 'ÁôΩÁ†ÇÁ≥ñ', fat: 0.0, protein: 0.0, ts: 99.8, price: 6.5 },
            { id: 'wat', name: 'Â∑•Ëâ∫Ê∞¥', fat: 0.0, protein: 0.0, ts: 0.0, price: 0.005 },
        ];

        // ‰ºòÂåñÂêéÁöÑÂæÆË∞ÉËæìÂÖ•ÁªÑ‰ª∂ (ÊåâÈíÆ‰∏çÊ∂àÂ§±ÔºåÂèòÁÅ∞)
        const StepperInput = ({ value, onChange, disabled, className }) => {
            const handleStep = (delta) => {
                if (disabled) return;
                vibrate();
                const safeVal = parseFloat(value) || 0;
                onChange({ target: { value: Math.max(0, safeVal + delta).toFixed(1) } });
            };
            return (
                <div className={`flex items-center gap-2 h-11 rounded-lg ${className} ${disabled ? '' : 'bg-blue-50/50 input-focus'}`}>
                    <button onClick={(e) => {e.stopPropagation(); handleStep(-1)}} disabled={disabled} className="stepper-btn">-</button>
                    <input 
                        type="number" 
                        value={value} 
                        disabled={disabled}
                        onChange={onChange}
                        className={`flex-1 text-center font-mono text-xl font-bold bg-transparent outline-none ${disabled ? 'text-gray-400' : 'text-blue-700'}`}
                    />
                    <button onClick={(e) => {e.stopPropagation(); handleStep(1)}} disabled={disabled} className="stepper-btn">+</button>
                </div>
            );
        };

        const App = () => {
            // State
            const [library, setLibrary] = useState(() => JSON.parse(localStorage.getItem('v5_lib')) || DEFAULT_INGREDIENTS);
            const [formula, setFormula] = useState(() => JSON.parse(localStorage.getItem('v5_formula')) || [{...DEFAULT_INGREDIENTS[0], uuid:'1', weight:850, locked:false}, {...DEFAULT_INGREDIENTS[5], uuid:'2', weight:60, locked:true}]);
            const [targets, setTargets] = useState(() => JSON.parse(localStorage.getItem('v5_targets')) || {fat:3.5, pro:3.0, ts:12.0});
            const [batchSize, setBatchSize] = useState(() => parseFloat(localStorage.getItem('v5_batch')) || 1000);
            const [isLocked, setIsLocked] = useState(() => JSON.parse(localStorage.getItem('v5_locked')) || false);
            const [savedRecipes, setSavedRecipes] = useState(() => JSON.parse(localStorage.getItem('v5_recipes')) || []);
            
            const [uiState, setUiState] = useState({ showAdd: false, showTargets: false, showRecipes: false, editId: null, mode: 'calc' });
            const [isSolving, setIsSolving] = useState(false);

            useEffect(() => {
                localStorage.setItem('v5_lib', JSON.stringify(library));
                localStorage.setItem('v5_formula', JSON.stringify(formula));
                localStorage.setItem('v5_targets', JSON.stringify(targets));
                localStorage.setItem('v5_batch', batchSize);
                localStorage.setItem('v5_locked', isLocked);
                localStorage.setItem('v5_recipes', JSON.stringify(savedRecipes));
            }, [library, formula, targets, batchSize, isLocked, savedRecipes]);

            // Core Calculation
            const res = useMemo(() => {
                let W=0, F=0, P=0, T=0, C=0;
                formula.forEach(i => {
                    const w = parseFloat(i.weight)||0;
                    W+=w; F+=w*(i.fat||0); P+=w*(i.protein||0); T+=w*(i.ts||0); C+=w*(i.price||0);
                });
                const safeW = W || 1;
                return {
                    w: W,
                    fat: F/safeW,
                    pro: P/safeW,
                    ts: T/safeW,
                    pf: F>0 ? P/F : 0,
                    costPerKg: C/safeW
                };
            }, [formula]);

            const updateItem = (uuid, k, v) => setFormula(formula.map(i => i.uuid===uuid ? {...i, [k]: v} : i));
            const delItem = (uuid) => { vibrate(); setFormula(formula.filter(i => i.uuid!==uuid)); };
            const addLibItem = (item) => { vibrate(); setFormula([...formula, {...item, uuid: Date.now().toString(), weight:0, locked:false}]); setUiState({...uiState, showAdd:false}); };
            
            const normalize = () => {
                vibrate();
                if(res.w === 0) return;
                const ratio = batchSize / res.w;
                setFormula(formula.map(i => ({...i, weight: parseFloat((i.weight*ratio).toFixed(2))})));
            };

            const balanceWater = () => {
                vibrate();
                const waterIdx = formula.findIndex(i => i.name.includes('Ê∞¥') || i.id === 'wat');
                if (waterIdx === -1) return alert("ËØ∑ÂÖàÊ∑ªÂä†'Â∑•Ëâ∫Ê∞¥'");
                const otherWeight = formula.reduce((acc, i, idx) => idx !== waterIdx ? acc + (parseFloat(i.weight)||0) : acc, 0);
                const waterNeeded = batchSize - otherWeight;
                if (waterNeeded < 0) return alert(`Ë∂ÖÈáç ${Math.abs(waterNeeded).toFixed(1)}gÔºåÊó†ÈúÄË°•Ê∞¥`);
                const newF = [...formula];
                newF[waterIdx].weight = parseFloat(waterNeeded.toFixed(2));
                setFormula(newF);
            };

            const copyReport = () => {
                vibrate();
                const date = new Date().toLocaleDateString();
                const txt = `üìã ‰π≥ÂìÅÈÖçÊñπ (${date})\n----------------\n` +
                    formula.map(i => `${i.name}: ${i.weight}g`).join('\n') +
                    `\n----------------\nÊÄªÈáç: ${res.w.toFixed(1)}g\nF${res.fat.toFixed(2)}% P${res.pro.toFixed(2)}% TS${res.ts.toFixed(2)}%`;
                navigator.clipboard.writeText(txt).then(() => alert("ÈÖçÊñπÂ∑≤Â§çÂà∂"));
            };

            const autoSolve = () => {
                vibrate();
                let bestF = JSON.parse(JSON.stringify(formula));
                const unlocked = bestF.filter(i => !i.locked);
                if(!unlocked.length) return alert("ËØ∑Ëß£ÈîÅËá≥Â∞ë‰∏ÄÁßçÂéüÊñô");
                const fixedW = bestF.reduce((a,b)=>b.locked?a+(parseFloat(b.weight)||0):a, 0);
                const targetW = batchSize - fixedW;
                if(targetW < 0) return alert("ÈîÅÂÆöË∂ÖÈáç");

                setIsSolving(true);
                setTimeout(() => {
                    let minErr = Infinity;
                    let bestWeights = unlocked.map(i => i.weight);
                    for(let k=0; k<3000; k++) {
                        let currentWs = new Array(unlocked.length).fill(0);
                        let sumR = unlocked.map(() => Math.random()).reduce((a,b)=>a+b, 0);
                        currentWs = unlocked.map((_, i) => (Math.random()/sumR)*targetW); // Simplified rand
                        
                        let cF=0, cP=0, cW=0;
                        bestF.forEach((item, idx) => {
                            let w = item.locked ? item.weight : 0;
                            if(!item.locked) {
                                const uIdx = unlocked.findIndex(u => u.uuid === item.uuid);
                                w = currentWs[uIdx];
                            }
                            cF += w * (item.fat||0); cP += w * (item.protein||0); cW += w;
                        });
                        const err = Math.abs((cF/cW) - targets.fat)*2 + Math.abs((cP/cW) - targets.pro);
                        if(err < minErr) { minErr = err; bestWeights = currentWs; }
                    }
                    const newF = bestF.map(i => {
                        if(i.locked) return i;
                        const uIdx = unlocked.findIndex(u => u.uuid === i.uuid);
                        return {...i, weight: parseFloat(bestWeights[uIdx].toFixed(2))};
                    });
                    setFormula(newF);
                    setIsSolving(false);
                    setUiState({...uiState, showTargets:false});
                }, 500);
            };

            const diffColor = (v, t) => {
                if(!t) return 'text-gray-800';
                const d = Math.abs(v - t);
                return d <= 0.05 ? 'text-green-600' : (d <= 0.2 ? 'text-orange-500' : 'text-red-600');
            };

            return (
                <div className="min-h-screen pb-24">
                    {/* Header */}
                    <header className="fixed top-0 left-0 right-0 z-50 header-glass pt-safe">
                        <div className="flex justify-between items-center px-4 h-12">
                            <div className="text-sm font-extrabold text-gray-600 tracking-wider flex items-center gap-2 tap-active" onClick={() => setUiState({...uiState, showRecipes:true})}>
                                <Icon d={ICONS.Folder} size={18} className="text-blue-600"/> DAIRY LAB
                            </div>
                            <div className="flex gap-4">
                                <button onClick={() => setUiState({...uiState, showTargets:true})} className="text-blue-600 flex items-center gap-1 text-xs font-bold bg-blue-50 px-3 py-1.5 rounded-full tap-active"><Icon d={ICONS.Target} size={14}/> ÁõÆÊ†á</button>
                                <button onClick={copyReport} className="text-gray-500 tap-active"><Icon d={ICONS.Share} size={20}/></button>
                            </div>
                        </div>

                        <div className="px-4 pb-3 flex items-center gap-2">
                            <div className={`flex-1 flex items-center bg-gray-100 rounded-xl px-3 h-10 transition-colors ${isLocked ? 'opacity-60' : ''}`}>
                                <span className="text-xs font-bold text-gray-500 mr-2">ÊäïÊñô</span>
                                <input type="number" value={batchSize} disabled={isLocked} onChange={e => setBatchSize(parseFloat(e.target.value))} className="bg-transparent flex-1 font-mono font-bold text-xl text-right outline-none text-gray-800"/>
                                <span className="text-xs font-bold text-gray-400 ml-1">g</span>
                            </div>
                            <button onClick={() => { vibrate(); setIsLocked(!isLocked); }} className={`w-10 h-10 flex items-center justify-center rounded-xl ${isLocked ? 'bg-amber-100 text-amber-600' : 'bg-gray-100 text-gray-400'} tap-active`}><Icon d={isLocked ? ICONS.Lock : ICONS.Unlock} size={18}/></button>
                            <button onClick={balanceWater} className="w-10 h-10 flex items-center justify-center bg-blue-100 text-blue-600 rounded-xl tap-active"><Icon d={ICONS.Drop} size={20}/></button>
                            <button onClick={normalize} className="px-4 h-10 bg-blue-600 text-white text-xs font-bold rounded-xl shadow-sm tap-active">ÂΩí‰∏ÄÂåñ</button>
                        </div>

                        <div className="grid grid-cols-4 border-t border-gray-100 h-16 bg-white">
                            {[
                                {l:'FAT', v:res.fat, t:targets.fat}, {l:'PRO', v:res.pro, t:targets.pro}, {l:'TS', v:res.ts, t:targets.ts}, {l:'PF', v:res.pf, t:0}
                            ].map((d,i) => (
                                <div key={i} className="stat-capsule">
                                    <div className="text-[10px] font-extrabold text-gray-400 scale-90 mb-0.5">{d.l}</div>
                                    <div className={`font-mono font-extrabold text-lg leading-none ${diffColor(d.v, d.t)}`}>{(d.v || 0).toFixed(2)}</div>
                                    {d.t > 0 && Math.abs(d.v - d.t) > 0.05 && <div className="text-[9px] text-gray-400 scale-90 mt-0.5 font-bold">{(d.v - d.t) > 0 ? '+' : ''}{(d.v - d.t || 0).toFixed(2)}</div>}
                                </div>
                            ))}
                        </div>
                    </header>

                    {/* List */}
                    <div className="pt-[145px] px-3"> 
                        <div className="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-100 mb-4">
                            <div className="flex text-[10px] text-gray-500 font-bold bg-gray-50 py-2 px-3 uppercase tracking-wide">
                                <div className="w-24">ÂéüÊñô</div>
                                <div className="flex-1 text-center">Ê∑ªÂä†Èáè (g)</div>
                                <div className="w-16 text-right">{uiState.mode === 'cost' ? 'Âçï‰ª∑' : 'Âç†ÊØî%'}</div>
                            </div>

                            {formula.map((item, idx) => (
                                <div key={item.uuid} className={`list-row tap-active ${item.locked ? 'locked-bg' : ''}`} onClick={() => setUiState({...uiState, editId: uiState.editId===item.uuid ? null : item.uuid})}>
                                    <div className="w-24 flex flex-col justify-center pr-1">
                                        <div className={`font-bold text-sm truncate flex items-center gap-1 ${item.locked ? 'text-gray-400' : 'text-gray-800'}`}>
                                            {item.name}
                                            {item.locked && <Icon d={ICONS.Lock} size={10} className="text-amber-500"/>}
                                        </div>
                                        <div className="text-[9px] text-gray-400 font-mono mt-0.5 font-medium">F{item.fat} P{item.protein}</div>
                                    </div>

                                    <div className="flex-1 px-1">
                                        <StepperInput 
                                            value={item.weight} 
                                            disabled={item.locked} 
                                            onChange={(e) => !item.locked && updateItem(item.uuid, 'weight', e.target.value)} 
                                        />
                                    </div>

                                    <div className="w-16 flex flex-col items-end justify-center gap-1 relative pl-1">
                                        <div className="font-bold text-xs text-gray-700 font-mono">
                                            {uiState.mode === 'cost' ? `¬•${item.price}` : `${res.w > 0 ? (item.weight/res.w*100).toFixed(1) : 0}%`}
                                        </div>
                                        <button onClick={(e) => { e.stopPropagation(); delItem(item.uuid); }} className="text-gray-300 hover:text-red-500 p-1"><Icon d={ICONS.X} size={14}/></button>
                                        {uiState.mode === 'cost' && <div className="cost-bar" style={{width: `${(item.weight*item.price) / (res.cost||1) * 100}%`}}></div>}
                                    </div>

                                    {/* Edit Panel */}
                                    {uiState.editId === item.uuid && (
                                        <div className="absolute left-0 right-0 top-full bg-white shadow-lg border-t border-gray-100 z-20 p-3 flex flex-col gap-3 animate-slide-up rounded-b-xl" onClick={e=>e.stopPropagation()}>
                                            <div className="flex justify-between items-center">
                                                <button onClick={() => updateItem(item.uuid, 'locked', !item.locked)} className={`px-4 py-2 rounded-lg text-xs font-bold flex items-center gap-1 transition-colors ${item.locked ? 'bg-amber-100 text-amber-700' : 'bg-gray-100 text-gray-600'}`}>
                                                    <Icon d={item.locked ? ICONS.Unlock : ICONS.Lock} size={14}/>
                                                    {item.locked ? 'Ëß£ÈîÅ' : 'ÈîÅÂÆö'}
                                                </button>
                                                <div className="flex items-center bg-gray-50 rounded-lg px-2 h-8">
                                                    <span className="text-[10px] text-gray-400 font-bold mr-1">Âçï‰ª∑ ¬•</span>
                                                    <input type="number" value={item.price} onChange={e=>updateItem(item.uuid,'price',e.target.value)} className="w-12 bg-transparent text-xs font-bold outline-none"/>
                                                </div>
                                            </div>
                                            <div className="grid grid-cols-3 gap-2">
                                                <div className="bg-gray-50 p-1.5 rounded text-center"><div className="text-[9px] text-gray-400 font-bold">FAT</div><input className="w-full bg-transparent text-center font-mono text-xs font-bold" value={item.fat} onChange={e=>updateItem(item.uuid,'fat',e.target.value)}/></div>
                                                <div className="bg-gray-50 p-1.5 rounded text-center"><div className="text-[9px] text-gray-400 font-bold">PRO</div><input className="w-full bg-transparent text-center font-mono text-xs font-bold" value={item.protein} onChange={e=>updateItem(item.uuid,'protein',e.target.value)}/></div>
                                                <div className="bg-gray-50 p-1.5 rounded text-center"><div className="text-[9px] text-gray-400 font-bold">TS</div><input className="w-full bg-transparent text-center font-mono text-xs font-bold" value={item.ts} onChange={e=>updateItem(item.uuid,'ts',e.target.value)}/></div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>

                        <div className="mt-2 text-center text-xs text-gray-400 font-mono">ÊÄªÊàêÊú¨: <span className="font-bold text-gray-700">¬•{(res.costPerKg || 0).toFixed(2)}/kg</span></div>
                        <button onClick={() => { vibrate(); setUiState({...uiState, showAdd:true}); }} className="mt-4 w-full py-3 rounded-xl border-2 border-dashed border-blue-200 text-blue-500 font-bold flex items-center justify-center gap-1 tap-active bg-white"><Icon d={ICONS.Plus} size={20}/> Ê∑ªÂä†ÂéüÊñô</button>
                    </div>

                    {/* Bottom Switcher */}
                    <div className="fixed bottom-6 left-1/2 -translate-x-1/2 bg-white/95 backdrop-blur shadow-xl border border-gray-100 rounded-full p-1 flex gap-1 z-40">
                        <button onClick={() => setUiState({...uiState, mode:'calc'})} className={`px-5 py-2.5 rounded-full text-xs font-bold transition-all ${uiState.mode==='calc' ? 'bg-gray-900 text-white shadow-md' : 'text-gray-500'}`}>ÈÖçÊñπ</button>
                        <button onClick={() => setUiState({...uiState, mode:'cost'})} className={`px-5 py-2.5 rounded-full text-xs font-bold transition-all ${uiState.mode==='cost' ? 'bg-green-600 text-white shadow-md' : 'text-gray-500'}`}>ÊàêÊú¨</button>
                    </div>

                    {/* Modals */}
                    {uiState.showAdd && (
                        <div className="fixed inset-0 z-50 bg-black/30 backdrop-blur-sm flex items-end" onClick={() => setUiState({...uiState, showAdd:false})}>
                            <div className="bg-white w-full rounded-t-2xl p-4 h-[60vh] overflow-y-auto" onClick={e=>e.stopPropagation()}>
                                <div className="font-bold text-lg mb-4 text-center text-gray-800">ÂéüÊñôÂ∫ì</div>
                                <div className="grid grid-cols-2 gap-3">
                                    {library.map(ing => (
                                        <div key={ing.id} onClick={() => addLibItem(ing)} className="p-3 bg-gray-50 rounded-xl tap-active border border-transparent active:border-blue-200">
                                            <div className="font-bold text-gray-800">{ing.name}</div>
                                            <div className="text-[10px] text-gray-400 mt-1 font-mono">F{ing.fat} P{ing.protein} TS{ing.ts}</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {uiState.showTargets && (
                        <div className="fixed inset-0 z-50 bg-black/30 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setUiState({...uiState, showTargets:false})}>
                            <div className="bg-white w-full max-w-xs rounded-2xl p-6 shadow-2xl" onClick={e=>e.stopPropagation()}>
                                <div className="font-bold text-lg mb-5 text-center text-gray-900">ÁõÆÊ†áËÆæÂÆö</div>
                                <div className="grid grid-cols-2 gap-4 mb-6">
                                    {['fat', 'pro', 'ts'].map(k => (
                                        <div key={k} className="bg-gray-50 rounded-lg p-2 border border-gray-100">
                                            <div className="text-[10px] text-gray-400 font-bold uppercase text-center">{k}%</div>
                                            <input type="number" value={targets[k]} onChange={e => setTargets({...targets, [k]:parseFloat(e.target.value)})} className="w-full bg-transparent font-bold text-xl outline-none text-center text-gray-800"/>
                                        </div>
                                    ))}
                                    <button onClick={autoSolve} disabled={isSolving} className="bg-blue-600 text-white rounded-lg font-bold text-xs flex flex-col items-center justify-center shadow-lg shadow-blue-200 tap-active p-2 h-full">
                                        <Icon d={ICONS.Wand} size={24}/>
                                        <span className="mt-1">{isSolving?'ËÆ°ÁÆó‰∏≠':'Êô∫ËÉΩÂπ≥Ë°°'}</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {/* Recipes Modal */}
                    {uiState.showRecipes && (
                        <div className="fixed inset-0 z-50 bg-black/30 backdrop-blur-sm flex items-center justify-center p-4" onClick={() => setUiState({...uiState, showRecipes:false})}>
                            <div className="bg-white w-full max-w-sm rounded-2xl p-5 shadow-2xl h-[60vh] flex flex-col" onClick={e=>e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="font-bold text-lg text-gray-900">ÈÖçÊñπÂ≠òÊ°£</h3>
                                    <button onClick={() => {
                                        const name = prompt("ËæìÂÖ•ÈÖçÊñπÂêçÁß∞");
                                        if(name) setSavedRecipes([...savedRecipes, {id:Date.now(), name, formula, targets, batchSize, date:new Date().toLocaleDateString()}]);
                                    }} className="text-blue-600 font-bold text-sm bg-blue-50 px-3 py-1.5 rounded-lg">+ ‰øùÂ≠òÂΩìÂâç</button>
                                </div>
                                <div className="flex-1 overflow-y-auto space-y-2">
                                    {savedRecipes.length===0 && <div className="text-center text-gray-400 mt-10 text-sm">ÊöÇÊó†Â≠òÊ°£</div>}
                                    {savedRecipes.map(r => (
                                        <div key={r.id} className="bg-gray-50 p-3 rounded-xl flex justify-between items-center border border-gray-100" onClick={() => {
                                            if(confirm(`Âä†ËΩΩ ${r.name}?`)) { setFormula(r.formula); setTargets(r.targets); setTargetBatchSize(r.targetBatchSize); setUiState({...uiState, showRecipes:false}); }
                                        }}>
                                            <div><div className="font-bold text-gray-800">{r.name}</div><div className="text-[10px] text-gray-400">{r.date}</div></div>
                                            <button onClick={(e)=>{e.stopPropagation(); setSavedRecipes(savedRecipes.filter(x=>x.id!==r.id))}} className="text-gray-300 hover:text-red-500 p-2"><Icon d={ICONS.Trash} size={16}/></button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
